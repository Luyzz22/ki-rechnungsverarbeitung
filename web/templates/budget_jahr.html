{% extends "base_app.html" %}
{% block title %}Budget Jahresansicht {{ jahr }} - SBS Invoice System{% endblock %}

{% block styles %}
<style>
    :root { --sbs-blue: #003856; --sbs-yellow: #FFB900; }
    .jahr-header { background: linear-gradient(135deg, var(--sbs-blue) 0%, #005580 100%); color: white; padding: 2rem; border-radius: 12px; margin-bottom: 2rem; }
    .jahr-selector { background: rgba(255,255,255,0.15); border: none; color: white; padding: 0.5rem 1rem; border-radius: 8px; }
    .jahr-selector option { color: var(--sbs-blue); }
    .back-btn { background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 0.5rem 1rem; border-radius: 8px; text-decoration: none; }
    .back-btn:hover { background: rgba(255,255,255,0.25); color: white; }
    .summary-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 2rem; }
    .summary-card { background: white; border-radius: 12px; padding: 1.5rem; box-shadow: 0 2px 12px rgba(0,0,0,0.08); text-align: center; }
    .summary-card .value { font-size: 1.75rem; font-weight: 700; color: var(--sbs-blue); }
    .summary-card .label { color: #6c757d; font-size: 0.875rem; }
    .jahres-table { background: white; border-radius: 12px; overflow-x: auto; box-shadow: 0 2px 12px rgba(0,0,0,0.08); }
    .jahres-table table { margin-bottom: 0; }
    .jahres-table thead { background: var(--sbs-blue); color: white; position: sticky; top: 0; }
    .jahres-table th { font-weight: 600; padding: 0.75rem 0.5rem; text-align: center; font-size: 0.8rem; border: none; white-space: nowrap; }
    .jahres-table th:first-child { text-align: left; padding-left: 1rem; min-width: 160px; }
    .jahres-table td { padding: 0.5rem; text-align: center; border-bottom: 1px solid #f0f0f0; font-size: 0.8rem; }
    .jahres-table td:first-child { text-align: left; padding-left: 1rem; font-weight: 500; }
    .cell-ok { background: rgba(40, 167, 69, 0.1); }
    .cell-warning { background: rgba(255, 193, 7, 0.2); }
    .cell-danger { background: rgba(220, 53, 69, 0.15); }
    .cell-critical { background: rgba(111, 66, 193, 0.15); }
    .cell-value { display: block; font-weight: 600; }
    .cell-budget { display: block; font-size: 0.65rem; color: #6c757d; }
    .total-row { background: #f8f9fa !important; font-weight: 700; }
    .total-row td { border-top: 2px solid var(--sbs-blue); padding: 1rem 0.5rem; }
    .heatmap-legend { display: flex; gap: 1rem; justify-content: center; margin-top: 1rem; font-size: 0.85rem; flex-wrap: wrap; }
    .legend-item { display: flex; align-items: center; gap: 0.5rem; }
    .legend-color { width: 20px; height: 20px; border-radius: 4px; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="jahr-header">
        <div class="row align-items-center">
            <div class="col-md-6">
                <a href="/budget" class="back-btn me-3"><i class="bi bi-arrow-left me-1"></i>Zurück</a>
                <h1 class="d-inline-block mb-0"><i class="bi bi-calendar3 me-2"></i>Jahresbudget {{ jahr }}</h1>
            </div>
            <div class="col-md-6 text-md-end mt-3 mt-md-0">
                <select class="jahr-selector" id="jahrSelect" onchange="window.location.href='/budget/jahr?jahr='+this.value">
                    {% for j in range(jahr - 2, jahr + 3) %}<option value="{{ j }}" {% if j == jahr %}selected{% endif %}>{{ j }}</option>{% endfor %}
                </select>
            </div>
        </div>
    </div>
    
    <div class="summary-cards">
        <div class="summary-card"><div class="value">{{ '{:,.0f}'.format(jahresbudget.gesamt_soll) }} €</div><div class="label">Jahresbudget Gesamt</div></div>
        <div class="summary-card"><div class="value">{{ '{:,.0f}'.format(jahresbudget.gesamt_ist) }} €</div><div class="label">Ausgaben YTD</div></div>
        <div class="summary-card"><div class="value">{{ '{:,.0f}'.format(jahresbudget.gesamt_soll - jahresbudget.gesamt_ist) }} €</div><div class="label">Verbleibend</div></div>
        <div class="summary-card">{% set auslastung = (jahresbudget.gesamt_ist / jahresbudget.gesamt_soll * 100) if jahresbudget.gesamt_soll > 0 else 0 %}<div class="value">{{ '{:.1f}'.format(auslastung) }}%</div><div class="label">Jahres-Auslastung</div></div>
    </div>
    
    <div class="jahres-table">
        <table class="table table-hover">
            <thead>
                <tr>
                    <th>Kategorie</th>
                    {% for m in range(1, 13) %}<th>{{ monat_namen[m-1][:3] }}</th>{% endfor %}
                    <th style="background:#002744">Σ Jahr</th>
                </tr>
            </thead>
            <tbody>
                {% for kat_id, kat_data in jahresbudget.kategorien.items() %}
                <tr>
                    <td>{{ kat_data.name }}</td>
                    {% for m in range(1, 13) %}
                        {% set md = kat_data.monate.get(m, {'soll': 0, 'ist': 0, 'auslastung': 0}) %}
                        {% set a = md.auslastung %}
                        {% set cc = 'cell-ok' if a < 80 else 'cell-warning' if a < 100 else 'cell-danger' if a < 120 else 'cell-critical' %}
                        <td class="{{ cc if md.soll > 0 else '' }}">
                            {% if md.ist > 0 %}<span class="cell-value">{{ '{:,.0f}'.format(md.ist) }}</span>{% endif %}
                            {% if md.soll > 0 %}<span class="cell-budget">/ {{ '{:,.0f}'.format(md.soll) }}</span>{% endif %}
                        </td>
                    {% endfor %}
                    <td><span class="cell-value">{{ '{:,.0f}'.format(kat_data.jahres_ist) }}</span><span class="cell-budget">/ {{ '{:,.0f}'.format(kat_data.jahres_soll) }}</span></td>
                </tr>
                {% endfor %}
                <tr class="total-row">
                    <td>GESAMT</td>
                    {% for m in range(1, 13) %}
                        {% set ms = namespace(soll=0, ist=0) %}
                        {% for kat_id, kat_data in jahresbudget.kategorien.items() %}
                            {% set md = kat_data.monate.get(m, {'soll': 0, 'ist': 0}) %}
                            {% set ms.soll = ms.soll + md.soll %}
                            {% set ms.ist = ms.ist + md.ist %}
                        {% endfor %}
                        <td><span class="cell-value">{{ '{:,.0f}'.format(ms.ist) }}</span><span class="cell-budget">/ {{ '{:,.0f}'.format(ms.soll) }}</span></td>
                    {% endfor %}
                    <td><span class="cell-value" style="color:var(--sbs-blue)">{{ '{:,.0f}'.format(jahresbudget.gesamt_ist) }}</span><span class="cell-budget">/ {{ '{:,.0f}'.format(jahresbudget.gesamt_soll) }}</span></td>
                </tr>
            </tbody>
        </table>
    </div>
    
    <div class="heatmap-legend">
        <div class="legend-item"><div class="legend-color cell-ok"></div><span>&lt; 80%</span></div>
        <div class="legend-item"><div class="legend-color cell-warning"></div><span>80-100%</span></div>
        <div class="legend-item"><div class="legend-color cell-danger"></div><span>100-120%</span></div>
        <div class="legend-item"><div class="legend-color cell-critical"></div><span>&gt; 120%</span></div>
    </div>
</div>
{% endblock %}
