<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <title>Ausgaben-Analyse ¬∑ SBS KI-Rechnungsverarbeitung</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="icon" href="/static/favicon.ico" />
  <link rel="stylesheet" href="/static/css/design-tokens.css" />
  <link rel="stylesheet" href="/static/css/components.css" />
  <link rel="stylesheet" href="/static/css/main.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    .analytics-container {
      max-width: 1400px;
      margin: 0 auto;
    }
    .filter-bar {
      background: var(--sbs-white);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 24px;
      display: flex;
      gap: 16px;
      align-items: center;
      flex-wrap: wrap;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    }
    .filter-bar label {
      font-weight: 500;
      font-size: 0.9rem;
    }
    .filter-bar select,
    .filter-bar input {
      padding: 8px 12px;
      border: 1px solid var(--sbs-border-soft);
      border-radius: 6px;
      font-size: 0.9rem;
    }
    .filter-bar button {
      background: var(--sbs-dark);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 500;
    }
    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }
    .kpi-card {
      background: var(--sbs-white);
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    }
    .kpi-card .value {
      font-size: 2rem;
      font-weight: 700;
      color: var(--sbs-dark);
    }
    .kpi-card .label {
      font-size: 0.85rem;
      color: var(--sbs-muted);
      margin-top: 4px;
    }
    .kpi-card .trend {
      font-size: 0.8rem;
      margin-top: 8px;
    }
    .kpi-card .trend.up {
      color: #dc3545;
    }
    .kpi-card .trend.down {
      color: #28a745;
    }
    .kpi-card.highlight {
      background: linear-gradient(135deg, #003856 0%, #00507a 100%);
    }
    .kpi-card.highlight .value,
    .kpi-card.highlight .label {
      color: white;
    }
    .charts-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 24px;
      margin-bottom: 24px;
    }
    .chart-card {
      background: var(--sbs-white);
      border-radius: 12px;
      padding: 24px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
    }
    .chart-card h3 {
      margin: 0 0 20px 0;
      font-size: 1rem;
      color: var(--sbs-dark);
    }
    .chart-card.full-width {
      grid-column: 1 / -1;
    }
    .top-list {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    .top-list li {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 0;
      border-bottom: 1px solid var(--sbs-border-soft);
    }
    .top-list li:last-child {
      border-bottom: none;
    }
    .top-list .rank {
      width: 28px;
      height: 28px;
      background: var(--sbs-bg);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 0.8rem;
      margin-right: 12px;
    }
    .top-list .name {
      flex: 1;
      font-weight: 500;
    }
    .top-list .amount {
      font-weight: 600;
      color: var(--sbs-dark);
    }
    .top-list .count {
      font-size: 0.8rem;
      color: var(--sbs-muted);
      margin-left: 8px;
    }
    .export-btn {
      background: var(--sbs-accent);
      color: var(--sbs-dark);
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    @media (max-width: 768px) {
      .charts-row {
        grid-template-columns: 1fr;
      }
    }
  
.hero-meta {
  font-size: 0.8rem;
  color: var(--sbs-muted);
  margin-top: 4px;
}


    /* Finance Copilot ‚Äì Suggestion Chips */
    .finance-copilot-suggestions {
      margin-bottom: 12px;
      padding: 10px 12px;
      border-radius: 10px;
      background: var(--sbs-bg, #f5f5f5);
      border: 1px solid var(--sbs-border-soft, #e0e0e0);
    }
    .finance-copilot-suggestions-label {
      font-size: 0.8rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.04em;
      color: var(--sbs-muted, #666666);
      margin-bottom: 6px;
    }
    .finance-copilot-suggestions-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    .finance-copilot-chip {
      border: 1px solid var(--sbs-border-soft, #d1d5db);
      background: #ffffff;
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 0.8rem;
      cursor: pointer;
      color: var(--sbs-dark, #111827);
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: background 0.15s ease, border-color 0.15s ease, transform 0.08s ease;
    }
    .finance-copilot-chip::before {
      content: "‚ü∂";
      font-size: 0.75rem;
      opacity: 0.65;
    }
    .finance-copilot-chip:hover {
      background: rgba(0,56,86,0.04);
      border-color: var(--sbs-dark, #003856);
      transform: translateY(-1px);
    }
    .finance-copilot-chip:active {
      transform: translateY(0);
    }
    @media (max-width: 768px) {
      .finance-copilot-suggestions-row {
        flex-direction: column;
        align-items: flex-start;
      }
    }

</style>
<style>
.skeleton {
  background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
  background-size: 200% 100%;
  animation: skeleton-loading 1.5s ease-in-out infinite;
  border-radius: 8px;
}
@keyframes skeleton-loading {
  0% { background-position: 200% 0; }
  100% { background-position: -200% 0; }
}
.skeleton-stat { height: 100px; margin-bottom: 16px; border-radius: 12px; }
.skeleton-chart { height: 250px; margin-bottom: 24px; border-radius: 12px; }
</style>
<style>
.empty-state {
  text-align: center;
  padding: 80px 24px;
  background: white;
  border-radius: 16px;
  margin: 40px 0;
}
.empty-state-icon { font-size: 4rem; opacity: 0.4; margin-bottom: 20px; }
.empty-state-title { font-size: 1.5rem; font-weight: 700; color: #1f2937; margin-bottom: 12px; }
.empty-state-description { color: #6b7280; margin-bottom: 24px; }
.empty-state-action {
  background: linear-gradient(135deg, #FFB900, #ff9500);
  color: #003856;
  padding: 14px 32px;
  border-radius: 10px;
  font-weight: 600;
  text-decoration: none;
  display: inline-block;
}
</style>
</head>
<body>

{% include 'partials/header.html' %}<section class="hero" style="padding: 40px 24px;">
  <div class="hero-content">
    <h1>üìä Ausgaben-Analyse</h1>
    <p class="hero-subtitle">√úbersicht und Trends Ihrer Rechnungsdaten</p>
    <p class="hero-meta">Report erstellt am <span id="analyticsGenerated"></span></p>
  </div>
</section>

<section class="section">
  <div class="analytics-container">
    
    <!-- Filter Bar -->
    <div class="filter-bar">
      <label>Zeitraum:</label>
      <select id="period">
        <option value="30">Letzte 30 Tage</option>
        <option value="90">Letzte 90 Tage</option>
        <option value="365" selected>Dieses Jahr</option>
        <option value="all">Alle Daten</option>
      </select>
      <button onclick="location.reload()">Aktualisieren</button>
      <button class="export-btn" onclick="window.print()">üìÑ Als PDF exportieren</button>
    </div>
    
    <!-- KPI Cards -->
    <!-- Insights Section -->
{% if insights %}
<div style="margin: 40px 0;">
  <h2 style="margin-bottom: 24px; color: #1f2937;">üí° Erkenntnisse</h2>
  <div style="display: grid; gap: 16px;">
    {% for insight in insights %}
    <div style="background: white; border-radius: 12px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); display: flex; align-items: start; gap: 16px; border-left: 4px solid {% if insight.type == 'success' %}#22c55e{% elif insight.type == 'warning' %}#f59e0b{% elif insight.type == 'error' %}#ef4444{% else %}#3b82f6{% endif %};">
      <div style="font-size: 2rem; flex-shrink: 0;">{{ insight.icon }}</div>
      <div style="flex: 1;">
        <h3 style="font-size: 1rem; font-weight: 600; color: #1f2937; margin-bottom: 4px;">{{ insight.title }}</h3>
        <p style="font-size: 0.9rem; color: #6b7280; margin: 0;">{{ insight.message }}</p>
      </div>
    </div>
    {% endfor %}
  </div>
</div>
{% endif %}

<div class="kpi-grid">
      <div class="kpi-card highlight" title="Summe aller Bruttobetr√§ge im ausgew√§hlten Zeitraum.">
        <div class="value">{{ "%.2f"|format(stats.total_amount) }}‚Ç¨</div>
        <div class="label">Gesamtausgaben</div>
      </div>
      <div class="kpi-card" title="Anzahl der verarbeiteten Rechnungen im ausgew√§hlten Zeitraum.">
        <div class="value">{{ stats.total_invoices }}</div>
        <div class="label">Rechnungen</div>
      </div>
      <div class="kpi-card" title="Durchschnittlicher Bruttobetrag pro Rechnung.">
        <div class="value">{{ "%.2f"|format(stats.avg_per_invoice) }}‚Ç¨</div>
        <div class="label">√ò pro Rechnung</div>
      </div>
      <div class="kpi-card" title="Anzahl unterschiedlicher Rechnungsaussteller im ausgew√§hlten Zeitraum.">
        <div class="value">{{ stats.unique_suppliers }}</div>
        <div class="label">Lieferanten</div>
      </div>
      <div class="kpi-card" title="Summe aller ermittelten Mehrwertsteuerbetr√§ge.">
        <div class="value">{{ "%.2f"|format(stats.total_mwst) }}‚Ç¨</div>
        <div class="label">MwSt. gesamt</div>
      </div>
    </div>
    
    <!-- Charts Row 1 -->
    <div class="charts-row">
      <div class="chart-card full-width">
        <h3>üìà Ausgaben pro Monat</h3>
        <canvas id="monthlyChart" height="100"></canvas>
      </div>
    </div>
    
    <!-- Charts Row 2 -->
    <div class="charts-row">
      <div class="chart-card">
        <h3>üè¢ Top 10 Lieferanten</h3>
        <ul class="top-list">
          {% for item in top_suppliers[:10] %}
          <li>
            <span class="rank">{{ loop.index }}</span>
            <span class="name">{{ item.name or 'Unbekannt' }}</span>
            <span class="amount">{{ "%.2f"|format(item.total) }}‚Ç¨</span>
            <span class="count">({{ item.count }})</span>
          </li>
          {% else %}
          <li style="justify-content: center; color: var(--sbs-muted);">Keine Daten</li>
          {% endfor %}
        </ul>
      </div>
      <div class="chart-card">
        <h3>üìä Verteilung nach Lieferant</h3>
        <canvas id="supplierChart"></canvas>
      </div>
    </div>
    
    <!-- Charts Row 3 -->
    <div class="charts-row">
      <div class="chart-card">
        <h3>üí∞ Brutto vs. Netto vs. MwSt.</h3>
        <canvas id="taxChart"></canvas>
      </div>
      <div class="chart-card">
        <h3>üìÖ Rechnungen pro Wochentag</h3>
        <canvas id="weekdayChart"></canvas>
      </div>
    </div>
    
    <!-- Charts Row 4 - KI Analytics -->
    <div class="charts-row">
      <div class="chart-card">
        <h3>ü§ñ KI-Konfidenz Verteilung</h3>
        <canvas id="confidenceChart"></canvas>
      </div>
      <div class="chart-card">
        <h3>‚ö° Verarbeitungs-Methode</h3>
        <canvas id="methodChart"></canvas>
      </div>
    </div>
    
  </div>
</section>



<script src="/static/js/main.js"></script>
<script>
// Grundfarben
const primary = '#0F4C81';
const accent = '#F0B762';
const neutral = '#E5E7EB';

// Palette f√ºr mehrere Lieferanten
const palette = [
  '#4E79A7', // blau
  '#F28E2B', // orange
  '#E15759', // rot
  '#76B7B2', // teal
  '#59A14F', // gr√ºn
  '#EDC948', // gelb
  '#B07AA1', // lila
  '#FF9DA7', // pink
  '#9C755F', // braun
  '#6C757D'  // grau
];

// Theme Toggle (nur wenn Button existiert)
const themeToggle = document.getElementById('theme-toggle');
if (themeToggle) {
  const savedTheme = localStorage.getItem('theme') || 'light';
  document.documentElement.setAttribute('data-theme', savedTheme);
  themeToggle.addEventListener('click', () => {
    const current = document.documentElement.getAttribute('data-theme');
    const next = current === 'dark' ? 'light' : 'dark';
    document.documentElement.setAttribute('data-theme', next);
    localStorage.setItem('theme', next);
  });
}

// Burger Menu (nur wenn Elemente existieren)
);
}

// Timestamp im Header setzen
document.addEventListener('DOMContentLoaded', function () {
  const ts = document.getElementById('analyticsGenerated');
  if (ts) {
    ts.textContent = new Date().toLocaleString('de-DE');
  }
});

// üìà Ausgaben pro Monat mit Trend & Drilldown
(function () {
  const canvas = document.getElementById('monthlyChart');
  if (!canvas) return;
  const ctx = canvas.getContext('2d');

  const labels = {{ monthly_labels | tojson }};
  const values = {{ monthly_values | tojson }};

  const chart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [{
        label: 'Brutto je Monat',
        data: values,
        backgroundColor: 'rgba(15, 76, 129, 0.85)',
        borderColor: primary,
        borderWidth: 1,
        borderRadius: 6,
        maxBarThickness: 40
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: function (context) {
              const v = context.parsed.y || 0;
              return v.toLocaleString('de-DE', { minimumFractionDigits: 2 }) + ' ‚Ç¨';
            }
          }
        }
      },
      scales: {
        x: {
          grid: { display: false }
        },
        y: {
          beginAtZero: true,
          grid: { color: neutral },
          ticks: {
            callback: function (value) {
              if (value >= 1000) {
                return (value / 1000).toLocaleString('de-DE', { maximumFractionDigits: 1 }) + 'k ‚Ç¨';
              }
              return value.toLocaleString('de-DE') + ' ‚Ç¨';
            }
          }
        }
      },
      onClick: (evt, elements) => {
        if (!elements.length) return;
        const idx = elements[0].index;
        const label = labels[idx];
        if (label) {
          // Drilldown: Monat -> History
          window.location.href = '/history?month=' + encodeURIComponent(label);
        }
      }
    }
  });

  // Trend f√ºr Gesamtausgaben (erste KPI-Karte)
  if (Array.isArray(values) && values.length >= 2) {
    const last = values[values.length - 1];
    let prev = null;
    for (let i = values.length - 2; i >= 0; i--) {
      if (values[i] !== null && values[i] !== 0) {
        prev = values[i];
        break;
      }
    }
    if (prev && prev !== 0) {
      const diff = last - prev;
      const pct = diff / prev * 100;
      const cards = document.querySelectorAll('.kpi-grid .kpi-card');
      if (cards[0]) {
        const trend = document.createElement('div');
        trend.classList.add('trend');
        const pctText = Math.abs(pct).toFixed(1).replace('.', ',') + '%';
        if (pct > 1.5) {
          trend.classList.add('up');
          trend.textContent = '‚ñ≤ ' + pctText + ' vs. Vormonat';
        } else if (pct < -1.5) {
          trend.classList.add('down');
          trend.textContent = '‚ñº ' + pctText + ' vs. Vormonat';
        } else {
          trend.textContent = '‚âà ' + pctText + ' vs. Vormonat';
        }
        cards[0].appendChild(trend);
      }
    }
  }
})();

// üìä Verteilung nach Lieferant mit Prozent & Drilldown
{% if top_suppliers %}
(function () {
  const canvas = document.getElementById('supplierChart');
  if (!canvas) return;
  const ctx = canvas.getContext('2d');

  const labels = {{ top_suppliers[:5] | map(attribute='name') | list | tojson }};
  const values = {{ top_suppliers[:5] | map(attribute='total') | list | tojson }};
  const colors = palette.slice(0, labels.length);
  const total = values.reduce((a, b) => a + b, 0);

  new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: labels,
      datasets: [{
        data: values,
        backgroundColor: colors,
        borderColor: '#ffffff',
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      cutout: '65%',
      plugins: {
        legend: {
          position: 'bottom',
          labels: { usePointStyle: true, boxWidth: 12 }
        },
        tooltip: {
          callbacks: {
            label: function (context) {
              const val = context.parsed || 0;
              const pct = total ? (val / total * 100).toFixed(1).replace('.', ',') + '%' : '';
              return context.label + ': ' +
                val.toLocaleString('de-DE', { minimumFractionDigits: 2 }) + ' ‚Ç¨' +
                (pct ? ' (' + pct + ')' : '');
            }
          }
        }
      },
      onClick: (evt, elements) => {
        if (!elements.length) return;
        const idx = elements[0].index;
        const label = labels[idx];
        if (label) {
          // Drilldown: Lieferant -> History
          window.location.href = '/history?supplier=' + encodeURIComponent(label);
        }
      }
    }
  });
})();
{% endif %}

// üí∞ Brutto vs. Netto vs. MwSt.
(function () {
  const canvas = document.getElementById('taxChart');
  if (!canvas) return;
  const ctx = canvas.getContext('2d');

  const netto = {{ stats.total_netto or 0 }};
  const mwst  = {{ stats.total_mwst  or 0 }};
  const total = netto + mwst;

  new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: ['Netto', 'MwSt.'],
      datasets: [{
        data: [netto, mwst],
        backgroundColor: ['rgba(15, 76, 129, 0.85)', 'rgba(240, 184, 98, 0.8)'],
        borderColor: '#ffffff',
        borderWidth: 1
      }]
    },
    options: {
      responsive: true,
      cutout: '65%',
      plugins: {
        legend: {
          position: 'bottom',
          labels: { usePointStyle: true }
        },
        tooltip: {
          callbacks: {
            label: function (context) {
              const val = context.parsed || 0;
              const pct = total ? (val / total * 100).toFixed(1).replace('.', ',') + '%' : '';
              return context.label + ': ' +
                     val.toLocaleString('de-DE', { minimumFractionDigits: 2 }) + ' ‚Ç¨' +
                     (pct ? ' (' + pct + ')' : '');
            }
          }
        }
      }
    }
  });
})();

// üìÖ Rechnungen pro Wochentag
(function () {
  const canvas = document.getElementById('weekdayChart');
  if (!canvas) return;
  const ctx = canvas.getContext('2d');

  const labels = ['Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa', 'So'];
  const values = {{ weekday_data | tojson }};

  new Chart(ctx, {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [{
        label: 'Rechnungen',
        data: values,
        backgroundColor: 'rgba(79, 117, 147, 0.85)',
        borderColor: '#4F7593',
        borderWidth: 1,
        borderRadius: 6,
        maxBarThickness: 40
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: function (context) {
              const v = context.parsed.y || 0;
              return v.toLocaleString('de-DE') + ' Rechnungen';
            }
          }
        }
      },
      scales: {
        x: {
          grid: { display: false }
        },
        y: {
          beginAtZero: true,
          grid: { color: neutral },
          ticks: {
            precision: 0
          }
        }
      }
    }
  });
})();
</script>

<script>
// KI-Konfidenz Chart
(function() {
  const canvas = document.getElementById("confidenceChart");
  if (!canvas) return;
  const ctx = canvas.getContext("2d");
  
  // Daten aus Backend (Platzhalter - wird vom Backend gef√ºllt)
  const confData = {{ confidence_distribution | default([30, 15, 5]) | tojson }};
  
  new Chart(ctx, {
    type: "doughnut",
    data: {
      labels: ["Hoch (‚â•80%)", "Mittel (50-79%)", "Niedrig (<50%)"],
      datasets: [{
        data: confData,
        backgroundColor: ["#10b981", "#f59e0b", "#ef4444"],
        borderWidth: 2,
        borderColor: "#fff"
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { position: "bottom" }
      }
    }
  });
})();

// Verarbeitungs-Methode Chart
(function() {
  const canvas = document.getElementById("methodChart");
  if (!canvas) return;
  const ctx = canvas.getContext("2d");
  
  const methodData = {{ method_distribution | default([85, 15]) | tojson }};
  
  new Chart(ctx, {
    type: "pie",
    data: {
      labels: ["Text-Extraktion", "Vision-Extraktion"],
      datasets: [{
        data: methodData,
        backgroundColor: ["#4E79A7", "#F28E2B"],
        borderWidth: 2,
        borderColor: "#fff"
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { position: "bottom" }
      }
    }
  });
})();
</script>



{% include 'partials/footer.html' %}


    <!-- Finance Snapshot ‚Äì Basis f√ºr Finance Copilot -->
    <section id="finance-overview" class="finance-overview">
      <div class="analytics-container">
        <header style="margin-bottom: 24px;">
          <h1 style="margin: 0 0 8px 0;">Finanz-√úberblick</h1>
          <p style="margin: 0; color: var(--sbs-muted); font-size: 0.9rem;">
            Zusammenfassung aller verarbeiteten Eingangsrechnungen ‚Äì ideal f√ºr CFOs und Finanzleitung.
          </p>
        </header>

        <div class="filter-bar">
          <div>
            <label for="finance-period">Zeitraum</label><br />
            <select id="finance-period" name="finance-period">
              <option value="30">Letzte 30 Tage</option>
              <option value="90" selected>Letzte 90 Tage</option>
              <option value="365">Letzte 12 Monate</option>
            </select>
          </div>
          <button type="button" id="finance-refresh">Aktualisieren</button>
          <div id="finance-error" style="color: #b91c1c; font-size: 0.85rem;"></div>
        </div>

        <div class="kpi-grid" id="finance-kpi-grid">
          <div class="kpi-card highlight">
            <div class="label">Gesamtbetrag (brutto)</div>
            <div class="value" id="kpi-total-gross">‚Äì</div>
            <div class="trend">Alle Rechnungen im gew√§hlten Zeitraum</div>
          </div>
          <div class="kpi-card">
            <div class="label">Gesamtbetrag (netto)</div>
            <div class="value" id="kpi-total-net">‚Äì</div>
          </div>
          <div class="kpi-card">
            <div class="label">Gesamt-MwSt.</div>
            <div class="value" id="kpi-total-vat">‚Äì</div>
          </div>
          <div class="kpi-card">
            <div class="label">Anzahl Rechnungen</div>
            <div class="value" id="kpi-total-invoices">‚Äì</div>
          </div>
          <div class="kpi-card">
            <div class="label">Dubletten (heuristisch)</div>
            <div class="value" id="kpi-duplicates">‚Äì</div>
          </div>
        </div>

        <div class="charts-row">
          <div class="chart-card full-width">
            <h3>Monatliche Ausgaben (Brutto)</h3>
            <div style="position: relative; height: 260px;">
              <canvas id="finance-monthly-chart"></canvas>
            </div>
          </div>
          <div class="chart-card full-width">
            <h3>Top-Lieferanten nach Ausgaben</h3>
            <ul class="top-list" id="finance-top-vendors">
              <li>
                <div class="name">Lade Daten‚Ä¶</div>
              </li>
            </ul>
          </div>
        </div>
      </div>
    </section>

    <script>
      (function() {
        function initFinanceOverview() {
          var periodSelect = document.getElementById('finance-period');
          if (!periodSelect) {
            return;
          }

          var refreshButton = document.getElementById('finance-refresh');
          var errorBox = document.getElementById('finance-error');

          var kpiTotalGross = document.getElementById('kpi-total-gross');
          var kpiTotalNet = document.getElementById('kpi-total-net');
          var kpiTotalVat = document.getElementById('kpi-total-vat');
          var kpiTotalInvoices = document.getElementById('kpi-total-invoices');
          var kpiDuplicates = document.getElementById('kpi-duplicates');
          var topVendorsList = document.getElementById('finance-top-vendors');
          var monthlyChartCanvas = document.getElementById('finance-monthly-chart');

          if (!monthlyChartCanvas) {
            return;
          }

          var monthlyChart = null;

          function formatCurrency(value) {
            var number = value || 0;
            try {
              return new Intl.NumberFormat('de-DE', {
                style: 'currency',
                currency: 'EUR'
              }).format(number);
            } catch (e) {
              return (number.toFixed ? number.toFixed(2) : number) + ' ‚Ç¨';
            }
          }

          function formatNumber(value) {
            var number = value || 0;
            try {
              return new Intl.NumberFormat('de-DE').format(number);
            } catch (e) {
              return String(number);
            }
          }

          function setError(message) {
            if (errorBox) {
              errorBox.textContent = message || '';
            }
          }

          function updateKpis(kpis) {
            if (!kpis) return;
            if (kpiTotalGross) kpiTotalGross.textContent = formatCurrency(kpis.total_gross);
            if (kpiTotalNet) kpiTotalNet.textContent = formatCurrency(kpis.total_net);
            if (kpiTotalVat) kpiTotalVat.textContent = formatCurrency(kpis.total_vat);
            if (kpiTotalInvoices) kpiTotalInvoices.textContent = formatNumber(kpis.total_invoices);
            if (kpiDuplicates) kpiDuplicates.textContent = formatNumber(kpis.duplicates_count);
          }

          function updateTopVendors(vendors) {
            if (!topVendorsList) return;
            var list = vendors || [];
            if (!list.length) {
              topVendorsList.innerHTML = '<li><span class="name">Keine Daten im gew√§hlten Zeitraum.</span></li>';
              return;
            }
            topVendorsList.innerHTML = list.map(function(vendor, index) {
              var name = vendor.rechnungsaussteller || 'Unbekannter Lieferant';
              var amount = formatCurrency(vendor.total_gross);
              var count = formatNumber(vendor.invoice_count);
              return (
                '<li>' +
                  '<div style="display:flex; align-items:center; gap:8px;">' +
                    '<span class="rank">' + (index + 1) + '</span>' +
                    '<span class="name">' + name + '</span>' +
                  '</div>' +
                  '<div>' +
                    '<span class="amount">' + amount + '</span>' +
                    '<span class="count">(' + count + ' Rechnungen)</span>' +
                  '</div>' +
                '</li>'
              );
            }).join('');
          }

          function updateMonthlyChart(trend) {
            if (!monthlyChartCanvas || typeof Chart === 'undefined') {
              return;
            }
            var ctx = monthlyChartCanvas.getContext('2d');
            var data = trend || [];
            var labels = data.map(function(row) { return row.year_month; });
            var values = data.map(function(row) { return row.total_gross || 0; });

            if (monthlyChart) {
              monthlyChart.data.labels = labels;
              monthlyChart.data.datasets[0].data = values;
              monthlyChart.update();
              return;
            }

            monthlyChart = new Chart(ctx, {
              type: 'bar',
              data: {
                labels: labels,
                datasets: [{
                  label: 'Bruttosumme',
                  data: values
                }]
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                  legend: { display: false }
                },
                scales: {
                  y: {
                    ticks: {
                      callback: function(value) {
                        return formatCurrency(value);
                      }
                    }
                  }
                }
              }
            });
          }

          function loadSnapshot() {
            setError('');
            var days = parseInt(periodSelect.value || '90', 10);
            var url = '/api/analytics/finance-snapshot?days=' + days;

            fetch(url)
              .then(function(response) {
                if (!response.ok) {
                  throw new Error('HTTP ' + response.status);
                }
                return response.json();
              })
              .then(function(data) {
                if (!data) return;
                updateKpis(data.kpis);
                updateTopVendors(data.top_vendors);
                updateMonthlyChart(data.monthly_trend);
              })
              .catch(function(error) {
                console.error('Finance snapshot error', error);
                setError('Die Finanz√ºbersicht konnte nicht geladen werden.');
              });
          }

          if (refreshButton) {
            refreshButton.addEventListener('click', loadSnapshot);
          }
          periodSelect.addEventListener('change', loadSnapshot);

          loadSnapshot();
        }

        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', initFinanceOverview);
        } else {
          initFinanceOverview();
        }
      })();
    </script>
    

    <!-- Finance Copilot ‚Äì In-App Chat f√ºr CFOs -->
    <style>
      .finance-copilot-toggle {
        position: fixed;
        right: 24px;
        bottom: 24px;
        z-index: 500;
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 9px 16px;
        border-radius: 999px;
        border: none;
        background: var(--sbs-dark, #003856);
        color: var(--sbs-white, #ffffff);
        font-size: 0.9rem;
        font-weight: 600;
        cursor: pointer;
        box-shadow: 0 12px 30px rgba(0, 0, 0, 0.18);
      }
      .finance-copilot-toggle:hover {
        background: #00263f;
      }
      .finance-copilot-icon {
        font-size: 1.1rem;
      }

      .finance-copilot-panel {
        position: fixed;
        right: 24px;
        bottom: 90px;
        width: 380px;
        max-width: calc(100% - 32px);
        z-index: 500;
        background: var(--sbs-white, #ffffff);
        border-radius: 16px;
        box-shadow: 0 18px 40px rgba(0, 0, 0, 0.26);
        display: flex;
        flex-direction: column;
        max-height: 70vh;
        transform: translateY(8px);
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.18s ease-out, transform 0.18s ease-out;
        overflow: hidden;
      }
      .finance-copilot-panel.is-open {
        opacity: 1;
        pointer-events: auto;
        transform: translateY(0);
      }
      .finance-copilot-header {
        padding: 14px 16px 10px 16px;
        border-bottom: 1px solid var(--sbs-border-soft, #e2e8f0);
        display: flex;
        align-items: flex-start;
        justify-content: space-between;
        gap: 10px;
      }
      .finance-copilot-title {
        font-size: 0.95rem;
        font-weight: 600;
        color: var(--sbs-dark, #0f172a);
      }
      .finance-copilot-subtitle {
        font-size: 0.8rem;
        color: var(--sbs-muted, #64748b);
        margin-top: 2px;
      }
      .finance-copilot-close {
        border: none;
        background: transparent;
        cursor: pointer;
        font-size: 1.1rem;
        line-height: 1;
        color: var(--sbs-muted, #64748b);
      }
      .finance-copilot-body {
        padding: 10px 16px 8px 16px;
        overflow-y: auto;
        flex: 1;
      }
      .finance-copilot-answer p {
        margin: 0 0 8px 0;
        font-size: 0.85rem;
        line-height: 1.4;
        color: var(--sbs-dark, #0f172a);
      }
      .finance-copilot-meta {
        font-size: 0.75rem;
        color: var(--sbs-muted, #64748b);
        margin-top: 4px;
      }
      .finance-copilot-status {
        font-size: 0.75rem;
        color: var(--sbs-muted, #64748b);
        margin-top: 4px;
      }
      .finance-copilot-suggestions {
        margin-top: 10px;
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
      }
      .finance-copilot-suggestion {
        border-radius: 999px;
        border: 1px solid var(--sbs-border-soft, #e2e8f0);
        padding: 4px 10px;
        font-size: 0.75rem;
        background: var(--sbs-bg, #f8fafc);
        color: var(--sbs-dark, #0f172a);
        cursor: pointer;
      }
      .finance-copilot-suggestion:hover {
        background: #e2e8f0;
      }
      .finance-copilot-form {
        padding: 8px 8px 10px 8px;
        border-top: 1px solid var(--sbs-border-soft, #e2e8f0);
        display: flex;
        gap: 6px;
        align-items: center;
        background: var(--sbs-bg, #f8fafc);
      }
      .finance-copilot-input {
        flex: 1;
        border-radius: 999px;
        border: 1px solid var(--sbs-border-soft, #e2e8f0);
        padding: 7px 11px;
        font-size: 0.8rem;
      }
      .finance-copilot-send {
        border-radius: 999px;
        border: none;
        padding: 7px 14px;
        font-size: 0.8rem;
        font-weight: 600;
        background: var(--sbs-dark, #003856);
        color: var(--sbs-white, #ffffff);
        cursor: pointer;
      }
      .finance-copilot-send:disabled {
        opacity: 0.5;
        cursor: default;
      }
      .finance-copilot-footnote {
        padding: 0 16px 10px 16px;
        font-size: 0.7rem;
        color: var(--sbs-muted, #64748b);
      }
      @media (max-width: 640px) {
        .finance-copilot-panel {
          right: 12px;
          left: 12px;
          width: auto;
          bottom: 80px;
          max-height: 65vh;
        }
        .finance-copilot-toggle {
          right: 12px;
          bottom: 16px;
        }
      }
    </style>

    <div class="finance-copilot-panel" id="finance-copilot-panel" aria-hidden="true">
      <div class="finance-copilot-header">
        <div>
          <div class="finance-copilot-title">Finance Copilot</div>
          <div class="finance-copilot-subtitle">
            Stellen Sie Fragen direkt an Ihre verarbeiteten Rechnungsdaten.
          </div>
        </div>
        <button type="button" class="finance-copilot-close" id="finance-copilot-close" aria-label="Fenster schlie√üen">√ó</button>
      </div>
      <div class="finance-copilot-body">
        <div class="finance-copilot-answer" id="finance-copilot-answer">
          <p>
            Hallo! Ich gebe Ihnen in wenigen Sekunden einen √úberblick √ºber Ihre Eingangsrechnungen ‚Äì
            z.B. ‚ÄûKurzer √úberblick √ºber unsere Ausgaben, bitte.‚Äú oder
            ‚ÄûWelche Lieferanten verursachen aktuell die h√∂chsten Kosten?‚Äú.
          </p>
        </div>
        <div class="finance-copilot-status" id="finance-copilot-status"></div>
        <div class="finance-copilot-suggestions" id="finance-copilot-suggestions">
          <button type="button" class="finance-copilot-suggestion"
            data-question="Gib mir einen √úberblick √ºber unsere Ausgaben der letzten 90 Tage." data-copilot-days="90"
            data-copilot-days="90">
            √úberblick letzte 90 Tage
          </button>
          <button type="button" class="finance-copilot-suggestion"
            data-question="Welche Lieferanten verursachen aktuell die h√∂chsten Kosten?" data-copilot-days="365"
            data-copilot-days="365">
            Teuerste Lieferanten
          </button>
          <button type="button" class="finance-copilot-suggestion"
            data-question="Wie haben sich unsere Ausgaben in den letzten 6 Monaten entwickelt?" data-copilot-days="180"
            data-copilot-days="180">
            Trend letzte 6 Monate
          </button>
        </div>
      </div>
                  <form class="finance-copilot-form" id="finance-copilot-form">
        <input
          type="text"
          id="finance-copilot-input"
          class="finance-copilot-input"
          placeholder="Frage an den Copilot ‚Äì z.B. √úberblick √ºber die letzten 90 Tage"
          autocomplete="off"
        />
        <button type="submit" class="finance-copilot-send" id="finance-copilot-send-btn" disabled>
          Senden
        </button>
      </form>
      <div class="finance-copilot-footnote">
        Nutzt ausschlie√ülich bereits verarbeitete Rechnungsdaten aus Ihrem Account.
      </div>
    </div>

    <button type="button" class="finance-copilot-toggle" id="finance-copilot-toggle">
      <span class="finance-copilot-icon">üí¨</span>
      <span class="finance-copilot-label">Finance Copilot</span>
    </button>

    <script>
    (function() {
      var panel = document.getElementById('finance-copilot-panel');
      if (!panel) { return; }

      var toggle = document.getElementById('finance-copilot-toggle');
      var closeBtn = document.getElementById('finance-copilot-close');
      var form = document.getElementById('finance-copilot-form');
          var suggestionButtons = document.querySelectorAll('.finance-copilot-chip[data-finance-question]');
          if (suggestionButtons && suggestionButtons.length) {
            suggestionButtons.forEach(function(btn) {
              btn.addEventListener('click', function() {
                var q = btn.getAttribute('data-finance-question') || '';
                var daysAttr = btn.getAttribute('data-copilot-days');
                if (daysAttr) {
                  var parsedDays = parseInt(daysAttr, 10);
                  if (!isNaN(parsedDays)) {
                    overrideDays = parsedDays;
                  }
                }
                if (!q) return;

                var input = document.getElementById('finance-copilot-input');
                if (!input) return;

                input.value = q;
                input.focus();

                if (form) {
                  var submitEvent = new Event('submit', { cancelable: true, bubbles: true });
                  form.dispatchEvent(submitEvent);
                }
              });
            });
          }

      var input = document.getElementById('finance-copilot-input');
      var answerBox = document.getElementById('finance-copilot-answer');
      var statusBox = document.getElementById('finance-copilot-status');
      var suggestionsBox = document.getElementById('finance-copilot-suggestions');
      var sendBtn = document.getElementById('finance-copilot-send-btn');
      var isLoading = false;
      var overrideDays = null;

      function setPanel(open) {
        if (!panel) return;
        if (open) {
          panel.classList.add('is-open');
          panel.setAttribute('aria-hidden', 'false');
          if (input) {
            setTimeout(function() { input.focus(); }, 150);
          }
        } else {
          panel.classList.remove('is-open');
          panel.setAttribute('aria-hidden', 'true');
        }
      }

      if (toggle) {
        toggle.addEventListener('click', function() {
          var open = !panel.classList.contains('is-open');
          setPanel(open);
        });
      }
      if (closeBtn) {
        closeBtn.addEventListener('click', function() {
          setPanel(false);
        });
      }

      function formatCurrency(value) {
        var number = value || 0;
        try {
          return new Intl.NumberFormat('de-DE', {
            style: 'currency',
            currency: 'EUR'
          }).format(number);
        } catch (e) {
          return (number.toFixed ? number.toFixed(2) : number) + ' ‚Ç¨';
        }
      }

      function formatNumber(value) {
        var number = value || 0;
        try {
          return new Intl.NumberFormat('de-DE').format(number);
        } catch (e) {
          return String(number);
        }
      }

      function setStatus(message) {
        if (!statusBox) return;
        statusBox.textContent = message || '';
      }

      function setLoading(loading) {
        isLoading = loading;
        if (sendBtn) {
          var disabled = loading || !input || !input.value.trim();
          sendBtn.disabled = disabled;
        }
        if (input) {
          input.disabled = loading;
        }
      }

      function handleSubmit(event) {
        if (event && event.preventDefault) {
          event.preventDefault();
        }
        if (!input || !input.value.trim() || isLoading) {
          return;
        }

        var question = input.value.trim();

        var days = 90;
        if (typeof overrideDays === 'number' && !isNaN(overrideDays)) {
          days = overrideDays;
          overrideDays = null;
        } else {
          var periodSelect = document.getElementById('finance-period');
          if (periodSelect && periodSelect.value) {
            var parsed = parseInt(periodSelect.value, 10);
            if (!isNaN(parsed)) {
              days = parsed;
            }
          }
        }

        setLoading(true);
        setStatus('Copilot analysiert Ihre Belegdaten ‚Ä¶');

        fetch('/api/copilot/finance/query', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            question: question,
            days: days
          })
        })
          .then(function(response) {
            if (!response.ok) {
              throw new Error('HTTP ' + response.status);
            }
            return response.json();
          })
          .then(function(data) {
            if (!data) {
              return;
            }

            if (answerBox) {
              answerBox.innerHTML = '';
              var p = document.createElement('p');
              p.textContent = data.answer || '';
              answerBox.appendChild(p);

              if (data.snapshot && data.snapshot.kpis) {
                var k = data.snapshot.kpis;
                var meta = document.createElement('p');
                meta.className = 'finance-copilot-meta';
                var summary = 'Zeitraum: letzte ' + (data.days || days) + ' Tage ¬∑ Rechnungen: ' +
                  formatNumber(k.total_invoices || 0) + ' ¬∑ Brutto: ' +
                  formatCurrency(k.total_gross || 0);
                meta.textContent = summary;
                answerBox.appendChild(meta);
              }
            }

            if (Array.isArray(data.suggested_questions) && suggestionsBox) {
              suggestionsBox.innerHTML = '';
              data.suggested_questions.forEach(function(q) {
                var btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'finance-copilot-suggestion';
                btn.textContent = q;
                btn.dataset.question = q;

                // Heuristik: Zeitraum aus der Frage ableiten, um days zu setzen
                try {
                  var lower = String(q || '').toLowerCase();
                  var days = null;
                  if (lower.indexOf('90 tage') !== -1) {
                    days = 90;
                  } else if (lower.indexOf('6 monat') !== -1) {
                    days = 180;
                  } else if (
                    lower.indexOf('12 monat') !== -1 ||
                    lower.indexOf('letzten 12 monaten') !== -1 ||
                    lower.indexOf('letzten jahr') !== -1 ||
                    lower.indexOf('letztes jahr') !== -1
                  ) {
                    days = 365;
                  }
                  if (days !== null) {
                    btn.setAttribute('data-copilot-days', String(days));
                  }
                } catch (e) {
                  // Fallback: einfach ohne days-Attribut lassen
                }

                suggestionsBox.appendChild(btn);
              });
            }

            if (input) {
              input.value = '';
            }
            setStatus('');
          })
          .catch(function(error) {
            console.error('Finance Copilot error', error);
            setStatus('Die Antwort konnte nicht geladen werden. Bitte versuchen Sie es erneut.');
          })
          .finally(function() {
            setLoading(false);
          });
      }

      if (form) {
        form.addEventListener('submit', handleSubmit);
      }

      if (input) {
        input.addEventListener('input', function() {
          if (sendBtn && !isLoading) {
            sendBtn.disabled = !input.value.trim();
          }
        });
      }

      if (suggestionsBox) {
        suggestionsBox.addEventListener('click', function(event) {
          var target = event.target;
          if (!target || !target.dataset || !target.dataset.question) {
            return;
          }
          var q = target.dataset.question;
          if (!input) {
            return;
          }
          input.value = q;
          if (sendBtn) {
            sendBtn.disabled = false;
          }
          handleSubmit();
        });
      }
    })();
    </script>
    

<script>
document.addEventListener('DOMContentLoaded', function () {
  var form  = document.getElementById('finance-copilot-form');
  var input = document.getElementById('finance-copilot-input');
  if (!form || !input) {
    return;
  }

  var buttons = document.querySelectorAll('[data-finance-question]');
  if (!buttons || !buttons.length) {
    return;
  }

  function submitWithQuestion(q) {
    if (!q) return;
    input.value = q;
    input.focus();

    var evt;
    if (typeof Event === 'function') {
      evt = new Event('submit', { bubbles: true, cancelable: true });
    } else {
      // Fallback f√ºr √§ltere Browser
      evt = document.createEvent('Event');
      evt.initEvent('submit', true, true);
    }
    form.dispatchEvent(evt);
  }

  buttons.forEach(function (btn) {
    btn.addEventListener('click', function () {
      var q = btn.getAttribute('data-finance-question') || '';
      submitWithQuestion(q);
    });
  });
});
</script>
</body>

</html>
