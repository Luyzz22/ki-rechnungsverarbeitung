<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <title>Jahres√ºbersicht {{ jahr }} ¬∑ SBS KI-Rechnungsverarbeitung</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" href="/static/favicon.ico">
  <link rel="stylesheet" href="/static/css/design-tokens.css">
  <link rel="stylesheet" href="/static/css/components.css">
  <link rel="stylesheet" href="/static/css/main.css">
  <style>
    :root {
      --sbs-blue: #003856;
      --sbs-yellow: #FFB900;
      --green-500: #10b981;
      --green-100: #d1fae5;
      --amber-500: #f59e0b;
      --amber-100: #fef3c7;
      --red-500: #ef4444;
      --red-100: #fee2e2;
      --purple-500: #8b5cf6;
      --purple-100: #ede9fe;
      --gray-50: #f9fafb;
      --gray-100: #f3f4f6;
      --gray-200: #e5e7eb;
      --gray-600: #4b5563;
      --gray-900: #111827;
    }
    
    * { box-sizing: border-box; }
    body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: var(--gray-50); }
    
    /* Page Header */
    .page-header {
      background: linear-gradient(135deg, var(--sbs-blue) 0%, #00507a 100%);
      padding: 32px 24px;
      color: #fff;
    }
    .page-header-inner {
      max-width: 1600px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 20px;
    }
    .page-title {
      display: flex;
      align-items: center;
      gap: 16px;
    }
    .page-title-icon {
      width: 56px;
      height: 56px;
      background: rgba(255,255,255,0.15);
      border-radius: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.8rem;
    }
    .page-title h1 {
      font-size: 1.8rem;
      font-weight: 700;
      margin: 0;
    }
    .page-title p {
      color: rgba(255,255,255,0.8);
      margin: 4px 0 0;
      font-size: 0.95rem;
    }
    .header-controls {
      display: flex;
      gap: 12px;
      align-items: center;
    }
    .year-select {
      padding: 12px 20px;
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,0.3);
      background: rgba(255,255,255,0.1);
      color: #fff;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
    }
    .year-select option { color: var(--gray-900); }
    .header-btn {
      padding: 12px 20px;
      border-radius: 8px;
      font-weight: 600;
      font-size: 0.9rem;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      border: none;
      transition: all 0.2s;
    }
    .header-btn.secondary {
      background: rgba(255,255,255,0.15);
      color: #fff;
      border: 1px solid rgba(255,255,255,0.3);
    }
    
    /* Stats Bar */
    .stats-bar {
      background: #fff;
      border-bottom: 1px solid var(--gray-200);
      padding: 20px 24px;
    }
    .stats-bar-inner {
      max-width: 1600px;
      margin: 0 auto;
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 24px;
    }
    @media (max-width: 1000px) {
      .stats-bar-inner { grid-template-columns: repeat(3, 1fr); }
    }
    .stat-card {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .stat-icon {
      width: 44px;
      height: 44px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
    }
    .stat-icon.blue { background: #dbeafe; }
    .stat-icon.green { background: var(--green-100); }
    .stat-icon.amber { background: var(--amber-100); }
    .stat-icon.red { background: var(--red-100); }
    .stat-icon.purple { background: var(--purple-100); }
    .stat-value {
      font-size: 1.4rem;
      font-weight: 700;
      color: var(--gray-900);
      line-height: 1;
    }
    .stat-label {
      font-size: 0.8rem;
      color: var(--gray-600);
      margin-top: 2px;
    }
    
    /* Main Container */
    .main-container {
      max-width: 1600px;
      margin: 0 auto;
      padding: 24px;
    }
    
    /* Table Container */
    .table-container {
      background: #fff;
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }
    .table-header {
      padding: 20px 24px;
      border-bottom: 1px solid var(--gray-200);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .table-header h3 {
      margin: 0;
      font-size: 1.1rem;
    }
    
    /* Year Table */
    .year-table-wrapper {
      overflow-x: auto;
    }
    .year-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
    }
    .year-table th {
      background: var(--sbs-blue);
      color: #fff;
      padding: 14px 12px;
      text-align: center;
      font-weight: 600;
      font-size: 0.8rem;
      position: sticky;
      top: 0;
    }
    .year-table th:first-child {
      text-align: left;
      padding-left: 20px;
      min-width: 180px;
    }
    .year-table th.total-col {
      background: #1e3a5f;
    }
    .year-table td {
      padding: 12px;
      text-align: center;
      border-bottom: 1px solid var(--gray-100);
    }
    .year-table td:first-child {
      text-align: left;
      padding-left: 20px;
      font-weight: 600;
      color: var(--gray-900);
    }
    .year-table tr:hover {
      background: var(--gray-50);
    }
    
    /* Cell Styles */
    .cell {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 2px;
    }
    .cell-ist {
      font-weight: 700;
      font-size: 0.9rem;
    }
    .cell-budget {
      font-size: 0.7rem;
      color: var(--gray-600);
    }
    .cell-bar {
      width: 100%;
      height: 4px;
      background: var(--gray-200);
      border-radius: 2px;
      margin-top: 4px;
      overflow: hidden;
    }
    .cell-bar-fill {
      height: 100%;
      border-radius: 2px;
      transition: width 0.3s;
    }
    
    /* Status Colors */
    .status-ok { background: rgba(16, 185, 129, 0.1); }
    .status-ok .cell-ist { color: var(--green-500); }
    .status-ok .cell-bar-fill { background: var(--green-500); }
    
    .status-warning { background: rgba(245, 158, 11, 0.1); }
    .status-warning .cell-ist { color: var(--amber-500); }
    .status-warning .cell-bar-fill { background: var(--amber-500); }
    
    .status-danger { background: rgba(239, 68, 68, 0.1); }
    .status-danger .cell-ist { color: var(--red-500); }
    .status-danger .cell-bar-fill { background: var(--red-500); }
    
    .status-critical { background: rgba(139, 92, 246, 0.15); }
    .status-critical .cell-ist { color: var(--purple-500); }
    .status-critical .cell-bar-fill { background: var(--purple-500); }
    
    .status-empty { background: var(--gray-50); }
    .status-empty .cell-ist { color: var(--gray-400); }
    
    /* Total Row */
    .total-row {
      background: var(--gray-100) !important;
      font-weight: 700;
    }
    .total-row td {
      border-top: 2px solid var(--sbs-blue);
      padding: 16px 12px;
    }
    .total-row td:first-child {
      color: var(--sbs-blue);
    }
    
    /* Legend */
    .legend {
      display: flex;
      justify-content: center;
      gap: 24px;
      padding: 20px;
      border-top: 1px solid var(--gray-200);
      flex-wrap: wrap;
    }
    .legend-item {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.85rem;
      color: var(--gray-600);
    }
    .legend-color {
      width: 16px;
      height: 16px;
      border-radius: 4px;
    }
    .legend-color.ok { background: var(--green-100); border: 1px solid var(--green-500); }
    .legend-color.warning { background: var(--amber-100); border: 1px solid var(--amber-500); }
    .legend-color.danger { background: var(--red-100); border: 1px solid var(--red-500); }
    .legend-color.critical { background: var(--purple-100); border: 1px solid var(--purple-500); }
  </style>
</head>
<body>
  {% include 'partials/header.html' %}

  <!-- Page Header -->
  <div class="page-header">
    <div class="page-header-inner">
      <div class="page-title">
        <div class="page-title-icon">üìÖ</div>
        <div>
          <h1>Jahres√ºbersicht {{ jahr }}</h1>
          <p>Budget-Auslastung aller Kategorien im Jahresvergleich</p>
        </div>
      </div>
      <div class="header-controls">
        <a href="/budget" class="header-btn secondary">‚Üê Zur√ºck zum Dashboard</a>
        <select class="year-select" onchange="window.location.href='/budget/jahr?jahr='+this.value">
          {% for j in range(jahr - 2, jahr + 3) %}
          <option value="{{ j }}" {% if j == jahr %}selected{% endif %}>{{ j }}</option>
          {% endfor %}
        </select>
      </div>
    </div>
  </div>

  <!-- Stats Bar -->
  <div class="stats-bar">
    <div class="stats-bar-inner">
      <div class="stat-card">
        <div class="stat-icon blue">üìä</div>
        <div>
          <div class="stat-value" id="stat-budget">-</div>
          <div class="stat-label">Jahresbudget</div>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon green">üí∞</div>
        <div>
          <div class="stat-value" id="stat-ist">-</div>
          <div class="stat-label">Ausgaben YTD</div>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon amber">üìà</div>
        <div>
          <div class="stat-value" id="stat-auslastung">-</div>
          <div class="stat-label">Auslastung</div>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon green">‚úÖ</div>
        <div>
          <div class="stat-value" id="stat-ok">-</div>
          <div class="stat-label">Im Budget</div>
        </div>
      </div>
      <div class="stat-card">
        <div class="stat-icon red">‚ö†Ô∏è</div>
        <div>
          <div class="stat-value" id="stat-over">-</div>
          <div class="stat-label">√úberschritten</div>
        </div>
      </div>
    </div>
  </div>

  <main class="main-container">
    <div class="table-container">
      <div class="table-header">
        <h3>üìã Monats√ºbersicht nach Kategorien</h3>
      </div>
      
      <div class="year-table-wrapper">
        <table class="year-table" id="year-table">
          <thead>
            <tr>
              <th>Kategorie</th>
              {% for m in monat_namen %}
              <th>{{ m[:3] }}</th>
              {% endfor %}
              <th class="total-col">Gesamt</th>
            </tr>
          </thead>
          <tbody id="table-body">
            <tr>
              <td colspan="14" style="text-align: center; padding: 40px;">
                <div style="font-size: 2rem; margin-bottom: 8px;">‚è≥</div>
                Lade Jahres√ºbersicht...
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      
      <div class="legend">
        <div class="legend-item">
          <div class="legend-color ok"></div>
          <span>Im Budget (< 80%)</span>
        </div>
        <div class="legend-item">
          <div class="legend-color warning"></div>
          <span>Warnung (80-100%)</span>
        </div>
        <div class="legend-item">
          <div class="legend-color danger"></div>
          <span>√úberschritten (100-120%)</span>
        </div>
        <div class="legend-item">
          <div class="legend-color critical"></div>
          <span>Kritisch (> 120%)</span>
        </div>
      </div>
    </div>
  </main>

  {% include 'partials/footer.html' %}

  <script>
    const jahr = {{ jahr }};
    
    async function loadData() {
      try {
        const res = await fetch(`/api/budget/jahresbudget?jahr=${jahr}`);
        const data = await res.json();
        
        renderTable(data);
        updateStats(data);
      } catch (err) {
        document.getElementById('table-body').innerHTML = `
          <tr>
            <td colspan="14" style="text-align: center; padding: 40px; color: #ef4444;">
              <div style="font-size: 2rem; margin-bottom: 8px;">‚ùå</div>
              Fehler beim Laden: ${err.message}
            </td>
          </tr>
        `;
      }
    }
    
    function renderTable(data) {
      const tbody = document.getElementById('table-body');
      const kategorien = data.kategorien || [];
      const monatsDaten = data.monats_daten || {};
      
      let html = '';
      let totals = Array(12).fill(0).map(() => ({ ist: 0, budget: 0 }));
      let gesamtIst = 0, gesamtBudget = 0;
      
      kategorien.forEach(kat => {
        let jahresIst = 0, jahresBudget = 0;
        
        html += `<tr><td>${kat.icon || 'üìÅ'} ${kat.name}</td>`;
        
        for (let m = 1; m <= 12; m++) {
          const key = `${kat.id}_${m}`;
          const d = monatsDaten[key] || { ist: 0, budget: 0 };
          const ist = d.ist || 0;
          const budget = d.budget || 0;
          const pct = budget > 0 ? (ist / budget) * 100 : 0;
          
          jahresIst += ist;
          jahresBudget += budget;
          totals[m-1].ist += ist;
          totals[m-1].budget += budget;
          
          let statusClass = 'status-empty';
          if (budget > 0) {
            if (pct < 80) statusClass = 'status-ok';
            else if (pct < 100) statusClass = 'status-warning';
            else if (pct < 120) statusClass = 'status-danger';
            else statusClass = 'status-critical';
          }
          
          html += `
            <td class="${statusClass}">
              <div class="cell">
                <span class="cell-ist">${ist > 0 ? ist.toLocaleString('de-DE', {maximumFractionDigits: 0}) : '-'}</span>
                ${budget > 0 ? `<span class="cell-budget">/ ${budget.toLocaleString('de-DE', {maximumFractionDigits: 0})}</span>` : ''}
                ${budget > 0 ? `<div class="cell-bar"><div class="cell-bar-fill" style="width: ${Math.min(pct, 100)}%"></div></div>` : ''}
              </div>
            </td>
          `;
        }
        
        gesamtIst += jahresIst;
        gesamtBudget += jahresBudget;
        
        const jahresPct = jahresBudget > 0 ? (jahresIst / jahresBudget) * 100 : 0;
        let jahresStatus = 'status-empty';
        if (jahresBudget > 0) {
          if (jahresPct < 80) jahresStatus = 'status-ok';
          else if (jahresPct < 100) jahresStatus = 'status-warning';
          else if (jahresPct < 120) jahresStatus = 'status-danger';
          else jahresStatus = 'status-critical';
        }
        
        html += `
          <td class="${jahresStatus}" style="font-weight: 700;">
            <div class="cell">
              <span class="cell-ist">${jahresIst.toLocaleString('de-DE', {maximumFractionDigits: 0})}</span>
              ${jahresBudget > 0 ? `<span class="cell-budget">/ ${jahresBudget.toLocaleString('de-DE', {maximumFractionDigits: 0})}</span>` : ''}
            </div>
          </td>
        </tr>`;
      });
      
      // Total Row
      html += `<tr class="total-row"><td>üìä GESAMT</td>`;
      for (let m = 0; m < 12; m++) {
        html += `
          <td>
            <div class="cell">
              <span class="cell-ist">${totals[m].ist.toLocaleString('de-DE', {maximumFractionDigits: 0})}</span>
              <span class="cell-budget">/ ${totals[m].budget.toLocaleString('de-DE', {maximumFractionDigits: 0})}</span>
            </div>
          </td>
        `;
      }
      html += `
        <td>
          <div class="cell">
            <span class="cell-ist" style="color: var(--sbs-blue);">${gesamtIst.toLocaleString('de-DE', {maximumFractionDigits: 0})} ‚Ç¨</span>
            <span class="cell-budget">/ ${gesamtBudget.toLocaleString('de-DE', {maximumFractionDigits: 0})} ‚Ç¨</span>
          </div>
        </td>
      </tr>`;
      
      tbody.innerHTML = html;
    }
    
    function updateStats(data) {
      const kategorien = data.kategorien || [];
      const monatsDaten = data.monats_daten || {};
      
      let gesamtBudget = 0, gesamtIst = 0;
      let okCount = 0, overCount = 0;
      
      kategorien.forEach(kat => {
        let katBudget = 0, katIst = 0;
        for (let m = 1; m <= 12; m++) {
          const key = `${kat.id}_${m}`;
          const d = monatsDaten[key] || {};
          katIst += d.ist || 0;
          katBudget += d.budget || 0;
        }
        gesamtBudget += katBudget;
        gesamtIst += katIst;
        
        if (katBudget > 0) {
          if (katIst <= katBudget) okCount++;
          else overCount++;
        }
      });
      
      const auslastung = gesamtBudget > 0 ? (gesamtIst / gesamtBudget) * 100 : 0;
      
      document.getElementById('stat-budget').textContent = gesamtBudget.toLocaleString('de-DE', {maximumFractionDigits: 0}) + ' ‚Ç¨';
      document.getElementById('stat-ist').textContent = gesamtIst.toLocaleString('de-DE', {maximumFractionDigits: 0}) + ' ‚Ç¨';
      document.getElementById('stat-auslastung').textContent = auslastung.toFixed(0) + '%';
      document.getElementById('stat-ok').textContent = okCount;
      document.getElementById('stat-over').textContent = overCount;
    }
    
    loadData();
  </script>
  <link rel="stylesheet" href="https://chat.sbsdeutschland.com/static/chat-widget.css">
  <script src="https://chat.sbsdeutschland.com/static/chat-widget.js" defer></script>
  <script src="/static/js/app-shell.js"></script>
</body>
</html>
