<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <title>Einstellungen ¬∑ SBS Deutschland</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="icon" href="/static/favicon.ico" />
  <link rel="stylesheet" href="/static/css/design-tokens.css" />
  <link rel="stylesheet" href="/static/css/components.css" />
  <link rel="stylesheet" href="/static/css/main.css" />
  <style>
    :root {
      --settings-card-bg: #ffffff;
      --settings-border: #e2e8f0;
      --settings-muted: #64748b;
      --settings-success: #22c55e;
      --settings-danger: #dc2626;
    }
    
    .settings-layout {
      display: grid;
      grid-template-columns: 260px 1fr;
      gap: 32px;
      max-width: 1200px;
      margin: 0 auto;
      padding: 32px 24px;
    }
    
    @media (max-width: 768px) {
      .settings-layout {
        grid-template-columns: 1fr;
        padding: 16px;
      }
    }
    
    /* Sidebar Navigation */
    .settings-nav {
      background: var(--settings-card-bg);
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
      height: fit-content;
      position: sticky;
      top: 100px;
    }
    
    .settings-nav-title {
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--settings-muted);
      margin-bottom: 16px;
    }
    
    .settings-nav-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 500;
      color: #334155;
      transition: all 0.2s;
      margin-bottom: 4px;
      border: none;
      background: none;
      width: 100%;
      text-align: left;
      font-size: 0.95rem;
    }
    
    .settings-nav-item:hover {
      background: #f1f5f9;
    }
    
    .settings-nav-item.active {
      background: linear-gradient(135deg, #003856, #00507a);
      color: white;
    }
    
    .settings-nav-item.danger {
      color: var(--settings-danger);
    }
    
    .settings-nav-item.danger:hover {
      background: #fef2f2;
    }
    
    /* Content Area */
    .settings-content {
      min-height: 600px;
    }
    
    .settings-section {
      display: none;
    }
    
    .settings-section.active {
      display: block;
    }
    
    .settings-card {
      background: var(--settings-card-bg);
      border-radius: 16px;
      padding: 32px;
      margin-bottom: 24px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    }
    
    .settings-card-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 24px;
    }
    
    .settings-card-icon {
      width: 48px;
      height: 48px;
      border-radius: 12px;
      background: linear-gradient(135deg, #003856, #00507a);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
    }
    
    .settings-card-title {
      margin: 0;
      font-size: 1.25rem;
      font-weight: 600;
    }
    
    .settings-card-subtitle {
      margin: 4px 0 0 0;
      color: var(--settings-muted);
      font-size: 0.9rem;
    }
    
    /* Form Elements */
    .form-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 20px;
    }
    
    @media (max-width: 600px) {
      .form-grid { grid-template-columns: 1fr; }
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-group.full-width {
      grid-column: 1 / -1;
    }
    
    .form-label {
      display: block;
      font-weight: 600;
      margin-bottom: 8px;
      font-size: 0.9rem;
      color: #334155;
    }
    
    .form-input {
      width: 100%;
      padding: 14px 16px;
      border: 2px solid var(--settings-border);
      border-radius: 10px;
      font-size: 1rem;
      transition: all 0.2s;
      background: #fafbfc;
      box-sizing: border-box;
    }
    
    .form-input:focus {
      outline: none;
      border-color: #003856;
      background: white;
      box-shadow: 0 0 0 3px rgba(0,56,86,0.1);
    }
    
    .form-input:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    
    /* Buttons */
    .btn {
      padding: 12px 24px;
      border-radius: 10px;
      font-weight: 600;
      font-size: 0.95rem;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #FFB900, #e6a600);
      color: #003856;
    }
    
    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(255,185,0,0.4);
    }
    
    .btn-secondary {
      background: #f1f5f9;
      color: #334155;
    }
    
    .btn-secondary:hover {
      background: #e2e8f0;
    }
    
    .btn-danger {
      background: #fef2f2;
      color: var(--settings-danger);
      border: 1px solid #fecaca;
    }
    
    .btn-danger:hover {
      background: #fee2e2;
    }
    
    /* Toggle Switch */
    .toggle-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 0;
      border-bottom: 1px solid var(--settings-border);
    }
    
    .toggle-row:last-child {
      border-bottom: none;
    }
    
    .toggle-info strong {
      display: block;
      margin-bottom: 4px;
    }
    
    .toggle-info small {
      color: var(--settings-muted);
      font-size: 0.85rem;
    }
    
    .toggle-switch {
      position: relative;
      width: 52px;
      height: 28px;
    }
    
    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    
    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #cbd5e1;
      border-radius: 28px;
      transition: 0.3s;
    }
    
    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 22px;
      width: 22px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      border-radius: 50%;
      transition: 0.3s;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    
    input:checked + .toggle-slider {
      background-color: var(--settings-success);
    }
    
    input:checked + .toggle-slider:before {
      transform: translateX(24px);
    }
    
    /* API Key Display */
    .api-key-box {
      background: #1e293b;
      border-radius: 12px;
      padding: 16px 20px;
      display: flex;
      align-items: center;
      gap: 12px;
      margin: 16px 0;
    }
    
    .api-key-box code {
      color: #22d3ee;
      font-family: 'Monaco', 'Menlo', monospace;
      font-size: 0.85rem;
      word-break: break-all;
      flex: 1;
    }
    
    .api-key-box button {
      background: #334155;
      border: none;
      color: white;
      padding: 10px 14px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1rem;
    }
    
    .api-key-box button:hover {
      background: #475569;
    }
    
    /* Status Badge */
    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 500;
    }
    
    .status-badge.success {
      background: #dcfce7;
      color: #166534;
    }
    
    .status-badge.warning {
      background: #fef3c7;
      color: #92400e;
    }
    
    .status-badge.danger {
      background: #fee2e2;
      color: #991b1b;
    }
    
    /* Subscription Card */
    .plan-card {
      background: linear-gradient(135deg, #003856, #00507a);
      border-radius: 16px;
      padding: 24px;
      color: white;
      margin-bottom: 24px;
    }
    
    .plan-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
    
    .plan-name {
      font-size: 1.5rem;
      font-weight: 700;
    }
    
    .plan-price {
      text-align: right;
    }
    
    .plan-price .amount {
      font-size: 2rem;
      font-weight: 700;
    }
    
    .plan-price .period {
      opacity: 0.8;
      font-size: 0.9rem;
    }
    
    .plan-features {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    
    .plan-features li {
      padding: 8px 0;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    /* Toast Notification */
    .toast-container {
      position: fixed;
      bottom: 24px;
      right: 24px;
      z-index: 9999;
    }
    
    .toast {
      background: #1e293b;
      color: white;
      padding: 16px 24px;
      border-radius: 12px;
      margin-top: 8px;
      display: flex;
      align-items: center;
      gap: 12px;
      animation: slideIn 0.3s ease;
      box-shadow: 0 8px 24px rgba(0,0,0,0.2);
    }
    
    .toast.success { border-left: 4px solid var(--settings-success); }
    .toast.error { border-left: 4px solid var(--settings-danger); }
    
    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }
    
    /* App Switcher */
    .app-products {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }
    
    .app-product-card {
      border: 2px solid var(--settings-border);
      border-radius: 16px;
      padding: 24px;
      transition: all 0.2s;
    }
    
    .app-product-card:hover {
      border-color: #003856;
      box-shadow: 0 4px 12px rgba(0,56,86,0.1);
    }
    
    .app-product-card.active {
      border-color: var(--settings-success);
      background: #f0fdf4;
    }
    
    .app-product-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
    }
    
    .app-product-icon {
      font-size: 2rem;
    }
    
    .app-product-name {
      font-weight: 600;
      font-size: 1.1rem;
    }
    
    .app-product-status {
      margin-left: auto;
    }
  </style>
</head>
<body>

{% include 'partials/header.html' %}

<section class="section" style="background: linear-gradient(180deg, #f8fafc 0%, #ffffff 100%); min-height: calc(100vh - 80px);">
  <div class="settings-layout">
    
    <!-- Sidebar Navigation -->
    <nav class="settings-nav">
      <div class="settings-nav-title">Einstellungen</div>
      
      <button class="settings-nav-item active" onclick="showSection('profile', this)">
        üë§ Profil
      </button>
      <button class="settings-nav-item" onclick="showSection('company', this)">
        üè¢ Unternehmen
      </button>
      <button class="settings-nav-item" onclick="showSection('security', this)">
        üîí Sicherheit
      </button>
      <button class="settings-nav-item" onclick="showSection('notifications', this)">
        üîî Benachrichtigungen
      </button>
      <button class="settings-nav-item" onclick="showSection('api', this)">
        üîë API-Zugang
      </button>
      <button class="settings-nav-item" onclick="showSection('subscription', this)">
        üí≥ Abonnement
      </button>
      <button class="settings-nav-item" onclick="showSection('products', this)">
        üì¶ Produkte
      </button>
      
      <div style="border-top: 1px solid var(--settings-border); margin: 16px 0;"></div>
      
      <a href="/logout" class="settings-nav-item danger" style="text-decoration: none;">
        üö™ Abmelden
      </a>
    </nav>
    
    <!-- Content Area -->
    <div class="settings-content">
      
      <!-- Profile Section -->
      <div id="section-profile" class="settings-section active">
        <div class="settings-card">
          <div class="settings-card-header">
            <div class="settings-card-icon">üë§</div>
            <div>
              <h2 class="settings-card-title">Pers√∂nliche Daten</h2>
              <p class="settings-card-subtitle">Ihre Kontaktinformationen</p>
            </div>
          </div>
          
          <form id="profileForm" onsubmit="saveProfile(event)">
            <div class="form-grid">
              <div class="form-group">
                <label class="form-label">Vorname</label>
                <input type="text" class="form-input" name="first_name" value="{{ user.name.split(' ')[0] if user and user.name else '' }}">
              </div>
              <div class="form-group">
                <label class="form-label">Nachname</label>
                <input type="text" class="form-input" name="last_name" value="{{ user.name.split(' ')[-1] if user and user.name and ' ' in user.name else '' }}">
              </div>
              <div class="form-group full-width">
                <label class="form-label">E-Mail-Adresse</label>
                <input type="email" class="form-input" value="{{ user.email if user else '' }}" disabled>
                <small style="color: var(--settings-muted); margin-top: 6px; display: block;">E-Mail kann nicht ge√§ndert werden</small>
              </div>
            </div>
            <button type="submit" class="btn btn-primary">üíæ Speichern</button>
          </form>
        </div>
      </div>
      
      <!-- Company Section -->
      <div id="section-company" class="settings-section">
        <div class="settings-card">
          <div class="settings-card-header">
            <div class="settings-card-icon">üè¢</div>
            <div>
              <h2 class="settings-card-title">Unternehmensdaten</h2>
              <p class="settings-card-subtitle">Informationen zu Ihrer Firma</p>
            </div>
          </div>
          
          <form id="companyForm" onsubmit="saveCompany(event)">
            <div class="form-grid">
              <div class="form-group full-width">
                <label class="form-label">Firmenname</label>
                <input type="text" class="form-input" name="company" value="{{ user.company if user else '' }}">
              </div>
              <div class="form-group">
                <label class="form-label">USt-IdNr.</label>
                <input type="text" class="form-input" name="vat_id" placeholder="DE123456789">
              </div>
              <div class="form-group">
                <label class="form-label">Handelsregister</label>
                <input type="text" class="form-input" name="hrb" placeholder="HRB 12345">
              </div>
            </div>
            <button type="submit" class="btn btn-primary">üíæ Speichern</button>
          </form>
        </div>
      </div>
      
      <!-- Security Section -->
      <div id="section-security" class="settings-section">
        <div class="settings-card">
          <div class="settings-card-header">
            <div class="settings-card-icon">üîí</div>
            <div>
              <h2 class="settings-card-title">Passwort √§ndern</h2>
              <p class="settings-card-subtitle">Aktualisieren Sie Ihr Passwort regelm√§√üig</p>
            </div>
          </div>
          
          <form id="passwordForm" onsubmit="changePassword(event)" style="max-width: 400px;">
            <div class="form-group">
              <label class="form-label">Aktuelles Passwort</label>
              <input type="password" class="form-input" name="current_password" required>
            </div>
            <div class="form-group">
              <label class="form-label">Neues Passwort</label>
              <input type="password" class="form-input" name="new_password" required minlength="8">
            </div>
            <div class="form-group">
              <label class="form-label">Passwort best√§tigen</label>
              <input type="password" class="form-input" name="confirm_password" required>
            </div>
            <button type="submit" class="btn btn-primary">üîí Passwort √§ndern</button>
          </form>
        </div>
        
        <div class="settings-card">
          <div class="settings-card-header">
            <div class="settings-card-icon">üîê</div>
            <div>
              <h2 class="settings-card-title">Zwei-Faktor-Authentifizierung</h2>
              <p class="settings-card-subtitle">Zus√§tzliche Sicherheit f√ºr Ihr Konto</p>
            </div>
          </div>
          
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <div>
              <strong>Status:</strong>
              <span id="2faStatus" class="status-badge warning">‚è≥ L√§dt...</span>
            </div>
            <button class="btn btn-secondary" onclick="manage2FA()">2FA verwalten</button>
          </div>
        </div>
      </div>
      
      <!-- Notifications Section -->
      <div id="section-notifications" class="settings-section">
        <div class="settings-card">
          <div class="settings-card-header">
            <div class="settings-card-icon">üîî</div>
            <div>
              <h2 class="settings-card-title">Benachrichtigungen</h2>
              <p class="settings-card-subtitle">Konfigurieren Sie wie Sie informiert werden</p>
            </div>
          </div>
          
          <div class="toggle-row">
            <div class="toggle-info">
              <strong>E-Mail Benachrichtigungen</strong>
              <small>Erhalten Sie Updates zu Ihren Dokumenten per E-Mail</small>
            </div>
            <label class="toggle-switch">
              <input type="checkbox" id="notifyEmail" onchange="saveNotification('email', this.checked)">
              <span class="toggle-slider"></span>
            </label>
          </div>
          
          <div class="toggle-row">
            <div class="toggle-info">
              <strong>Slack Integration</strong>
              <small>Benachrichtigungen an Ihren Slack Workspace senden</small>
            </div>
            <label class="toggle-switch">
              <input type="checkbox" id="notifySlack" onchange="saveNotification('slack', this.checked)">
              <span class="toggle-slider"></span>
            </label>
          </div>
          
          <div class="toggle-row">
            <div class="toggle-info">
              <strong>W√∂chentlicher Report</strong>
              <small>Zusammenfassung Ihrer Aktivit√§ten jeden Montag</small>
            </div>
            <label class="toggle-switch">
              <input type="checkbox" id="notifyWeekly" onchange="saveNotification('weekly', this.checked)">
              <span class="toggle-slider"></span>
            </label>
          </div>
        </div>
      </div>
      
      <!-- API Section -->
      <div id="section-api" class="settings-section">
        <div class="settings-card">
          <div class="settings-card-header">
            <div class="settings-card-icon">üîë</div>
            <div>
              <h2 class="settings-card-title">API-Zugang</h2>
              <p class="settings-card-subtitle">REST API f√ºr Ihre Integrationen</p>
            </div>
          </div>
          
          <p style="color: var(--settings-muted); margin-bottom: 16px;">
            Nutzen Sie unsere REST API f√ºr die Integration in Ihre Systeme. 
            <a href="https://docs.sbsdeutschland.com/api" target="_blank" style="color: #003856;">Dokumentation ‚Üí</a>
          </p>
          
          <div id="apiKeyContainer">
            <!-- Wird via JavaScript gef√ºllt -->
            <p style="color: var(--settings-muted);">L√§dt...</p>
          </div>
        </div>
      </div>
      
      <!-- Subscription Section -->
      <div id="section-subscription" class="settings-section">
        <div class="plan-card" id="planCard">
          <div class="plan-card-header">
            <div>
              <div style="opacity: 0.8; font-size: 0.85rem; margin-bottom: 4px;">Aktueller Plan</div>
              <div class="plan-name" id="currentPlanName">L√§dt...</div>
            </div>
            <div class="plan-price">
              <span class="amount" id="currentPlanPrice">-</span>
              <span class="period" id="planPeriod">/ Monat</span>
            </div>
          </div>
          <ul class="plan-features" id="currentPlanFeatures">
            <li>L√§dt...</li>
          </ul>
        </div>
        
        <!-- Produkte (f√ºr Multi-Produkt Subscriptions) -->
        <div class="settings-card" id="productsCard" style="display: none;">
          <div class="settings-card-header">
            <div class="settings-card-icon">üì¶</div>
            <div>
              <h2 class="settings-card-title">Aktive Produkte</h2>
              <p class="settings-card-subtitle">Ihre SBS Anwendungen</p>
            </div>
          </div>
          <div id="activeProducts"></div>
        </div>
        
        <div class="settings-card" id="billingCard">
          <div class="settings-card-header">
            <div class="settings-card-icon">üí≥</div>
            <div>
              <h2 class="settings-card-title">Abrechnung verwalten</h2>
              <p class="settings-card-subtitle">Zahlungsmethode, Rechnungen, Plan √§ndern</p>
            </div>
          </div>
          
          <div style="display: flex; gap: 12px; flex-wrap: wrap;">
            <button class="btn btn-primary" onclick="openBillingPortal()">üí≥ Billing Portal</button>
            <button class="btn btn-secondary" onclick="viewPricing()">üìä Pl√§ne vergleichen</button>
          </div>
        </div>
      </div>
      
      <!-- Products Section -->
      <div id="section-products" class="settings-section">
        <div class="settings-card">
          <div class="settings-card-header">
            <div class="settings-card-icon">üì¶</div>
            <div>
              <h2 class="settings-card-title">SBS Produkte</h2>
              <p class="settings-card-subtitle">Ihre aktiven Anwendungen</p>
            </div>
          </div>
          
          <div class="app-products">
            <div class="app-product-card active">
              <div class="app-product-header">
                <span class="app-product-icon">üìÑ</span>
                <span class="app-product-name">KI-Rechnungsverarbeitung</span>
                <span class="app-product-status status-badge success">‚úì Aktiv</span>
              </div>
              <p style="color: var(--settings-muted); margin: 0 0 16px 0;">
                Automatische Rechnungserkennung und -verarbeitung
              </p>
              <a href="https://app.sbsdeutschland.com" class="btn btn-secondary" style="text-decoration: none;">√ñffnen ‚Üí</a>
            </div>
            
            <div class="app-product-card active">
              <div class="app-product-header">
                <span class="app-product-icon">üìë</span>
                <span class="app-product-name">KI-Vertragsanalyse</span>
                <span class="app-product-status status-badge success">‚úì Aktiv</span>
              </div>
              <p style="color: var(--settings-muted); margin: 0 0 16px 0;">
                Intelligente Vertragsanalyse und Risikobewertung
              </p>
              <a href="https://contract.sbsdeutschland.com" class="btn btn-secondary" style="text-decoration: none;">√ñffnen ‚Üí</a>
            </div>
          </div>
        </div>
      </div>
      
    </div>
  </div>
</section>

{% include 'partials/footer.html' %}

<div class="toast-container" id="toastContainer"></div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// NAVIGATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function showSection(sectionId, btn) {
  // Deaktiviere alle Sections und Nav-Items
  document.querySelectorAll('.settings-section').forEach(s => s.classList.remove('active'));
  document.querySelectorAll('.settings-nav-item').forEach(n => n.classList.remove('active'));
  
  // Aktiviere gew√§hlte Section
  document.getElementById('section-' + sectionId).classList.add('active');
  btn.classList.add('active');
  
  // URL Hash aktualisieren
  history.replaceState(null, null, '#' + sectionId);
  
  // Lazy-Load Daten f√ºr die Section
  if (sectionId === 'api') loadApiKeys();
  if (sectionId === 'security') load2FAStatus();
  if (sectionId === 'subscription') loadSubscription();
  if (sectionId === 'notifications') loadNotifications();
}

// URL Hash beim Laden pr√ºfen
document.addEventListener('DOMContentLoaded', function() {
  var hash = window.location.hash.replace('#', '');
  if (hash) {
    var btn = document.querySelector('[onclick*="' + hash + '"]');
    if (btn) showSection(hash, btn);
  }
  
  // Initiale Daten laden
  load2FAStatus();
  loadApiKeys();
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// TOAST NOTIFICATIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function showToast(message, type) {
  var container = document.getElementById('toastContainer');
  var toast = document.createElement('div');
  toast.className = 'toast ' + (type || 'success');
  toast.innerHTML = (type === 'error' ? '‚ùå ' : '‚úÖ ') + message;
  container.appendChild(toast);
  
  setTimeout(function() {
    toast.style.opacity = '0';
    setTimeout(function() { toast.remove(); }, 300);
  }, 4000);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PROFILE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function saveProfile(e) {
  e.preventDefault();
  var form = e.target;
  var data = {
    name: (form.first_name.value + ' ' + form.last_name.value).trim()
  };
  
  fetch('/api/profile', {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(data)
  })
  .then(r => r.json())
  .then(function(res) {
    if (res.success) {
      showToast('Profil gespeichert!');
    } else {
      showToast(res.error || 'Fehler beim Speichern', 'error');
    }
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// COMPANY
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function saveCompany(e) {
  e.preventDefault();
  var form = e.target;
  
  fetch('/api/profile/company', {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      company: form.company.value,
      vat_id: form.vat_id.value,
      hrb: form.hrb.value
    })
  })
  .then(r => r.json())
  .then(function(res) {
    if (res.success) {
      showToast('Firmendaten gespeichert!');
    } else {
      showToast(res.error || 'Fehler beim Speichern', 'error');
    }
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// PASSWORD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function changePassword(e) {
  e.preventDefault();
  var form = e.target;
  
  if (form.new_password.value !== form.confirm_password.value) {
    showToast('Passw√∂rter stimmen nicht √ºberein', 'error');
    return;
  }
  
  fetch('/api/profile/password', {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      current_password: form.current_password.value,
      new_password: form.new_password.value
    })
  })
  .then(r => r.json())
  .then(function(res) {
    if (res.success) {
      showToast('Passwort ge√§ndert!');
      form.reset();
    } else {
      showToast(res.error || 'Fehler beim √Ñndern', 'error');
    }
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// 2FA
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function load2FAStatus() {
  fetch('/api/2fa/status')
    .then(r => r.json())
    .then(function(data) {
      var badge = document.getElementById('2faStatus');
      if (data.enabled) {
        badge.className = 'status-badge success';
        badge.innerHTML = '‚úÖ Aktiviert';
      } else {
        badge.className = 'status-badge warning';
        badge.innerHTML = '‚ö†Ô∏è Nicht aktiviert';
      }
    })
    .catch(function() {
      document.getElementById('2faStatus').innerHTML = '‚ùì Unbekannt';
    });
}

function manage2FA() {
  window.location.href = '/security';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// NOTIFICATIONS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function loadNotifications() {
  fetch('/api/notifications/settings')
    .then(r => r.json())
    .then(function(data) {
      document.getElementById('notifyEmail').checked = data.email || false;
      document.getElementById('notifySlack').checked = data.slack || false;
      document.getElementById('notifyWeekly').checked = data.weekly || false;
    })
    .catch(function() {});
}

function saveNotification(type, value) {
  fetch('/api/notifications/settings', {
    method: 'PUT',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ [type]: value })
  })
  .then(r => r.json())
  .then(function(res) {
    if (res.success) {
      showToast('Einstellung gespeichert!');
    }
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// API KEYS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function loadApiKeys() {
  fetch('/api/keys')
    .then(r => r.json())
    .then(function(data) {
      var container = document.getElementById('apiKeyContainer');
      
      if (data.keys && data.keys.length > 0) {
        var key = data.keys[0];
        container.innerHTML = `
          <div class="api-key-box">
            <code id="apiKeyCode">${key.key_prefix}...</code>
            <button onclick="copyApiKey('${key.key_prefix}...')" title="Kopieren">üìã</button>
          </div>
          <button class="btn btn-danger" onclick="revokeApiKey('${key.id}')">Widerrufen</button>
        `;
      } else {
        container.innerHTML = `
          <p style="color: var(--settings-muted); margin-bottom: 16px;">Noch kein API-Key generiert.</p>
          <button class="btn btn-primary" onclick="generateApiKey()">üîë API-Key generieren</button>
          <div id="newKeyDisplay"></div>
        `;
      }
    })
    .catch(function() {
      document.getElementById('apiKeyContainer').innerHTML = '<p>Fehler beim Laden</p>';
    });
}

function generateApiKey() {
  fetch('/api/keys', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: '{"name":"API Key"}' })
    .then(r => r.json())
    .then(function(data) {
      if (data.key) {
        document.getElementById('newKeyDisplay').innerHTML = `
          <div class="api-key-box" style="margin-top: 16px;">
            <code>${data.key}</code>
            <button onclick="copyApiKey('${data.key}')">üìã</button>
          </div>
          <p style="color: var(--settings-success); margin-top: 8px;">‚ö†Ô∏è Speichern Sie diesen Key - er wird nur einmal angezeigt!</p>
        `;
        showToast('API-Key generiert!');
      }
    });
}

function revokeApiKey(keyId) {
  if (!confirm('API-Key wirklich widerrufen? Alle Integrationen werden ung√ºltig.')) return;
  
  fetch('/api/keys/' + keyId, { method: 'DELETE' })
    .then(r => r.json())
    .then(function(res) {
      if (res.success) {
        showToast('API-Key widerrufen');
        loadApiKeys();
      }
    });
}

function copyApiKey(key) {
  navigator.clipboard.writeText(key);
  showToast('API-Key kopiert!');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// SUBSCRIPTION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

function loadSubscription() {
  fetch('/api/subscription')
    .then(r => r.json())
    .then(function(data) {
      if (data.error) {
        document.getElementById('currentPlanName').textContent = 'Fehler';
        return;
      }
      
      // Plan anzeigen
      if (data.plan) {
        document.getElementById('currentPlanName').textContent = data.plan.name || 'Free';
        document.getElementById('currentPlanPrice').textContent = data.plan.price || '0‚Ç¨';
        
        // Admin-Styling
        if (data.plan.is_admin) {
          document.getElementById('planCard').style.background = 'linear-gradient(135deg, #10b981, #059669)';
          document.getElementById('planPeriod').textContent = '';
        }
      }
      
      // Features anzeigen
      if (data.features && data.features.length > 0) {
        var featuresHtml = data.features.map(function(f) {
          return '<li>' + f + '</li>';
        }).join('');
        document.getElementById('currentPlanFeatures').innerHTML = featuresHtml;
      }
      
      // Produkte anzeigen (falls vorhanden)
      if (data.products && data.products.length > 0) {
        document.getElementById('productsCard').style.display = 'block';
        var productsHtml = data.products.map(function(p) {
          return '<div style="display:flex;justify-content:space-between;padding:12px 0;border-bottom:1px solid #e2e8f0;">' +
            '<div><strong>' + p.name + '</strong>' + (p.plan ? '<br><small style="color:#64748b;">' + p.plan + '</small>' : '') + '</div>' +
            '<div style="text-align:right;"><span class="status-badge success">‚úì ' + (p.status || 'Aktiv') + '</span>' +
            (p.usage ? '<br><small style="color:#64748b;">Nutzung: ' + p.usage + '</small>' : '') + '</div></div>';
        }).join('');
        document.getElementById('activeProducts').innerHTML = productsHtml;
      }
      
      // Billing-Card f√ºr Admins anpassen
      if (data.plan && data.plan.is_admin) {
        document.getElementById('billingCard').innerHTML = '<div class="settings-card-header"><div class="settings-card-icon">üëë</div><div><h2 class="settings-card-title">Admin-Zugang</h2><p class="settings-card-subtitle">Sie haben unbegrenzten Zugang zu allen Funktionen</p></div></div><p style="color:#64748b;">Als Admin haben Sie automatisch Zugriff auf alle Enterprise-Features ohne Abrechnungslimit.</p>';
      }
    })
    .catch(function(e) {
      console.error('Subscription load error:', e);
      document.getElementById('currentPlanName').textContent = 'Fehler beim Laden';
    });
}

function openBillingPortal() {
  fetch('/api/billing/portal', { method: 'POST' })
    .then(r => r.json())
    .then(function(data) {
      if (data.url) {
        window.location.href = data.url;
      } else {
        showToast(data.error || 'Billing Portal nicht verf√ºgbar', 'error');
      }
    })
    .catch(function() {
      showToast('Fehler beim √ñffnen des Billing Portals', 'error');
    });
}

function viewPricing() {
  window.location.href = '/pricing';
}
</script>

<link rel="stylesheet" href="https://chat.sbsdeutschland.com/static/chat-widget.css">
<script src="https://chat.sbsdeutschland.com/static/chat-widget.js" defer></script>
</body>
</html>
