<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8">
  <title>Finance Copilot ¬∑ SBS KI-Rechnungsverarbeitung</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <link rel="icon" href="/static/favicon.ico">
  <link rel="stylesheet" href="/static/css/design-tokens.css">
  <link rel="stylesheet" href="/static/css/components.css">
  <link rel="stylesheet" href="/static/css/main.css">
  <link rel="stylesheet" href="/static/css/app-shell.css">
  
  <style>
    /* Enterprise Copilot Design */
    .copilot-main { padding: 32px 24px 60px; background: #f1f5f9; min-height: calc(100vh - 200px); }
    .copilot-layout { max-width: 1200px; margin: 0 auto; display: grid; grid-template-columns: 1fr 340px; gap: 24px; }
    @media (max-width: 960px) { .copilot-layout { grid-template-columns: 1fr; } }
    
    /* Chat Card */
    .chat-card { background: white; border-radius: 20px; box-shadow: 0 10px 40px rgba(0,56,86,0.1); overflow: hidden; display: flex; flex-direction: column; height: 620px; }
    .chat-header { background: linear-gradient(135deg, #003856, #004d73); color: white; padding: 20px 24px; display: flex; align-items: center; gap: 16px; }
    .chat-header-icon { width: 48px; height: 48px; background: rgba(255,255,255,0.15); border-radius: 14px; display: flex; align-items: center; justify-content: center; font-size: 24px; }
    .chat-header-info h2 { margin: 0; font-size: 1.25rem; font-weight: 600; }
    .chat-header-info p { margin: 4px 0 0; font-size: 0.85rem; opacity: 0.85; }
    .chat-header-controls { margin-left: auto; display: flex; gap: 8px; }
    .chat-header-select { background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.3); color: white; padding: 6px 12px; border-radius: 8px; font-size: 0.8rem; cursor: pointer; }
    .chat-header-select option { background: #003856; color: white; }
    
    /* Messages Area */
    .chat-messages { flex: 1; overflow-y: auto; padding: 24px; display: flex; flex-direction: column; gap: 16px; background: #f8fafc; }
    .message { max-width: 85%; padding: 14px 18px; border-radius: 18px; line-height: 1.6; font-size: 0.95rem; }
    .message-user { align-self: flex-end; background: #003856; color: white; border-bottom-right-radius: 6px; }
    .message-assistant { align-self: flex-start; background: white; color: #1e293b; border: 1px solid #e2e8f0; border-bottom-left-radius: 6px; box-shadow: 0 2px 8px rgba(0,0,0,0.04); }
    .message-meta { font-size: 0.75rem; color: #64748b; margin-top: 8px; padding-top: 8px; border-top: 1px solid #e2e8f0; }
    .message-tags { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 8px; }
    .message-tag { font-size: 0.7rem; padding: 3px 8px; background: #f1f5f9; border-radius: 999px; color: #475569; }
    
    /* Typing Indicator */
    .message-typing { display: flex; gap: 6px; padding: 16px 20px; }
    .message-typing span { width: 8px; height: 8px; background: #94a3b8; border-radius: 50%; animation: typing 1.4s infinite; }
    .message-typing span:nth-child(2) { animation-delay: 0.2s; }
    .message-typing span:nth-child(3) { animation-delay: 0.4s; }
    @keyframes typing { 0%, 60%, 100% { transform: translateY(0); opacity: 0.4; } 30% { transform: translateY(-6px); opacity: 1; } }
    
    /* Input Area */
    .chat-input-area { padding: 16px 20px; background: white; border-top: 1px solid #e2e8f0; }
    .chat-input-wrapper { display: flex; gap: 12px; align-items: flex-end; }
    .chat-input { flex: 1; padding: 14px 18px; border: 2px solid #e2e8f0; border-radius: 14px; font-size: 0.95rem; resize: none; min-height: 50px; max-height: 120px; font-family: inherit; transition: border-color 0.2s; }
    .chat-input:focus { outline: none; border-color: #003856; }
    .chat-send-btn { width: 50px; height: 50px; border: none; background: linear-gradient(135deg, #003856, #004d73); color: white; border-radius: 14px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: transform 0.2s, box-shadow 0.2s; }
    .chat-send-btn:hover:not(:disabled) { transform: scale(1.05); box-shadow: 0 4px 12px rgba(0,56,86,0.3); }
    .chat-send-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    
    /* Sidebar */
    .sidebar-card { background: white; border-radius: 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.06); overflow: hidden; }
    .sidebar-header { padding: 16px 20px; border-bottom: 1px solid #e2e8f0; font-weight: 600; color: #1e293b; display: flex; align-items: center; gap: 8px; }
    .sidebar-content { padding: 16px; }
    
    /* KPI Grid */
    .kpi-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .kpi-item { background: #f8fafc; border-radius: 12px; padding: 14px; border: 1px solid #e2e8f0; }
    .kpi-label { font-size: 0.75rem; color: #64748b; margin-bottom: 4px; }
    .kpi-value { font-size: 1.1rem; font-weight: 700; color: #003856; }
    .kpi-foot { font-size: 0.7rem; color: #94a3b8; margin-top: 2px; }
    
    /* Top Vendors List */
    .vendor-list { margin-top: 12px; }
    .vendor-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid #f1f5f9; }
    .vendor-item:last-child { border-bottom: none; }
    .vendor-name { font-size: 0.85rem; color: #1e293b; font-weight: 500; }
    .vendor-amount { font-size: 0.85rem; color: #003856; font-weight: 600; }
    
    /* Quick Actions */
    .quick-actions { display: flex; flex-direction: column; gap: 8px; }
    .quick-action { padding: 12px 14px; background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 10px; font-size: 0.85rem; color: #475569; cursor: pointer; text-align: left; transition: all 0.2s; display: flex; align-items: center; gap: 10px; }
    .quick-action:hover { background: #003856; color: white; border-color: #003856; }
    .quick-action-icon { font-size: 1.1rem; }
    
    /* Welcome Message */
    .welcome-message { text-align: center; padding: 50px 30px; color: #64748b; }
    .welcome-message h3 { color: #1e293b; margin-bottom: 12px; font-size: 1.3rem; }
    .welcome-message p { max-width: 400px; margin: 0 auto 24px; line-height: 1.6; }
    .welcome-suggestions { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; }
    .welcome-suggestion { padding: 10px 16px; background: white; border: 1px solid #e2e8f0; border-radius: 20px; font-size: 0.85rem; cursor: pointer; transition: all 0.2s; }
    .welcome-suggestion:hover { background: #003856; color: white; border-color: #003856; }
    
    /* Hero Section */
    .hero-compact { background: linear-gradient(135deg, #003856 0%, #004d73 55%, #021019 100%); color: white; padding: 32px 24px; }
    .hero-compact .container { max-width: 1200px; margin: 0 auto; }
    .hero-badge { display: inline-flex; align-items: center; gap: 8px; padding: 6px 14px; border-radius: 999px; background: rgba(15,23,42,0.7); border: 1px solid rgba(148,163,184,0.6); font-size: 0.75rem; letter-spacing: 0.1em; text-transform: uppercase; }
    .hero-badge .dot { width: 8px; height: 8px; border-radius: 50%; background: #22d3ee; box-shadow: 0 0 12px rgba(34,211,238,0.6); }
    .hero-compact h1 { font-size: 2rem; margin: 12px 0 8px; }
    .hero-compact p { opacity: 0.9; max-width: 600px; }
  </style>
</head>
<body>

{% include 'partials/header.html' %}

<div class="hero-compact">
  <div class="container">
    <div class="hero-badge"><span class="dot"></span> FINANCE COPILOT</div>
    <h1>üí∞ Finance Copilot</h1>
    <p>Ihr KI-Assistent f√ºr Ausgabenanalyse, Cash-Flow-Fragen und CFO-Insights basierend auf Ihren verarbeiteten Rechnungen.</p>
  </div>
</div>

<div class="copilot-main">
  <div class="copilot-layout">
    <!-- Chat Card -->
    <div class="chat-card">
      <div class="chat-header">
        <div class="chat-header-icon">üí∞</div>
        <div class="chat-header-info">
          <h2>Finance Copilot</h2>
          <p>Powered by GPT-4 ¬∑ Finanzexperte</p>
        </div>
        <div class="chat-header-controls">
          <select id="copilot-days" class="chat-header-select">
            <option value="90">90 Tage</option>
            <option value="180">6 Monate</option>
            <option value="365" selected>12 Monate</option>
            <option value="730">24 Monate</option>
          </select>
        </div>
      </div>
      
      <div class="chat-messages" id="chatMessages">
        <div class="welcome-message" id="welcomeMessage">
          <h3>üëã Willkommen beim Finance Copilot!</h3>
          <p>Ich analysiere Ihre verarbeiteten Rechnungen und beantworte Fragen zu Ausgaben, Lieferanten und Cash-Flow.</p>
          <div class="welcome-suggestions">
            <div class="welcome-suggestion" onclick="askQuestion('Gib mir einen CFO-√úberblick √ºber unsere Ausgaben')">üìä CFO-√úberblick</div>
            <div class="welcome-suggestion" onclick="askQuestion('Welche Lieferanten verursachen die h√∂chsten Kosten?')">üè≠ Top Lieferanten</div>
            <div class="welcome-suggestion" onclick="askQuestion('Zeig mir Auff√§lligkeiten bei Zahlungszielen und Skonto')">üí≥ Zahlungsziele</div>
            <div class="welcome-suggestion" onclick="askQuestion('Wie haben sich unsere Ausgaben im Jahresvergleich entwickelt?')">üìà Jahrestrend</div>
          </div>
        </div>
      </div>
      
      <div class="chat-input-area">
        <div class="chat-input-wrapper">
          <textarea class="chat-input" id="chatInput" placeholder="Fragen Sie etwas √ºber Ihre Finanzdaten..." rows="1" onkeydown="handleKeyDown(event)"></textarea>
          <button class="chat-send-btn" id="sendBtn" onclick="sendMessage()" disabled>
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="22" y1="2" x2="11" y2="13"></line>
              <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
            </svg>
          </button>
        </div>
      </div>
    </div>
    
    <!-- Sidebar -->
    <div style="display: flex; flex-direction: column; gap: 20px;">
      <!-- KPIs -->
      <div class="sidebar-card">
        <div class="sidebar-header">üìä Finanz-Snapshot</div>
        <div class="sidebar-content">
          <div class="kpi-grid">
            <div class="kpi-item">
              <div class="kpi-label">Gesamtbetrag</div>
              <div class="kpi-value" id="kpi-total">‚Äì</div>
              <div class="kpi-foot">brutto</div>
            </div>
            <div class="kpi-item">
              <div class="kpi-label">Rechnungen</div>
              <div class="kpi-value" id="kpi-count">‚Äì</div>
              <div class="kpi-foot">Anzahl</div>
            </div>
            <div class="kpi-item">
              <div class="kpi-label">MwSt. gesamt</div>
              <div class="kpi-value" id="kpi-vat">‚Äì</div>
              <div class="kpi-foot">summiert</div>
            </div>
            <div class="kpi-item">
              <div class="kpi-label">√ò pro Rechnung</div>
              <div class="kpi-value" id="kpi-avg">‚Äì</div>
              <div class="kpi-foot">Durchschnitt</div>
            </div>
          </div>
          
          <div class="vendor-list" id="vendorList">
            <div style="padding: 20px; text-align: center; color: #64748b; font-size: 0.85rem;">Laden...</div>
          </div>
        </div>
      </div>
      
      <!-- Quick Actions -->
      <div class="sidebar-card">
        <div class="sidebar-header">‚ö° Schnellanalysen</div>
        <div class="sidebar-content">
          <div class="quick-actions">
            <button class="quick-action" onclick="askQuestion('Analysiere die Konzentration auf unsere Top-Lieferanten und zeige Risiken')">
              <span class="quick-action-icon">üè≠</span> Lieferanten-Konzentration
            </button>
            <button class="quick-action" onclick="askQuestion('Welche Skonti k√∂nnten wir besser nutzen?')">
              <span class="quick-action-icon">üí∏</span> Skonto-Optimierung
            </button>
            <button class="quick-action" onclick="askQuestion('Zeig mir ungew√∂hnliche oder auff√§llige Rechnungen')">
              <span class="quick-action-icon">‚ö†Ô∏è</span> Anomalien erkennen
            </button>
            <button class="quick-action" onclick="askQuestion('Erstelle eine Zusammenfassung f√ºr das Board-Meeting')">
              <span class="quick-action-icon">üìã</span> Board-Summary
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

{% include 'partials/footer.html' %}

<script>
// Formatter
function fmtCurrency(v) {
  try { return new Intl.NumberFormat('de-DE', {style:'currency',currency:'EUR'}).format(v||0); }
  catch(e) { return (v||0).toFixed(2) + ' ‚Ç¨'; }
}
function fmtNumber(v) {
  try { return new Intl.NumberFormat('de-DE').format(v||0); }
  catch(e) { return String(v||0); }
}

let isLoading = false;
let chatHistory = [];

// Load Snapshot
async function loadSnapshot() {
  const days = document.getElementById('copilot-days').value || 365;
  try {
    const res = await fetch('/api/analytics/finance-snapshot?days=' + days);
    const data = await res.json();
    if (data && data.kpis) {
      const k = data.kpis;
      document.getElementById('kpi-total').textContent = fmtCurrency(k.total_gross);
      document.getElementById('kpi-count').textContent = fmtNumber(k.total_invoices);
      document.getElementById('kpi-vat').textContent = fmtCurrency(k.total_vat);
      const avg = k.total_invoices > 0 ? k.total_gross / k.total_invoices : 0;
      document.getElementById('kpi-avg').textContent = fmtCurrency(avg);
      
      // Top Vendors
      const vendors = data.top_vendors || [];
      const vendorList = document.getElementById('vendorList');
      if (vendors.length > 0) {
        vendorList.innerHTML = '<div style="font-size:0.8rem;font-weight:600;color:#1e293b;margin-bottom:8px;">Top Lieferanten</div>' +
          vendors.slice(0,5).map(v => 
            '<div class="vendor-item"><span class="vendor-name">' + (v.name||'Unbekannt') + '</span><span class="vendor-amount">' + fmtCurrency(v.total) + '</span></div>'
          ).join('');
      } else {
        vendorList.innerHTML = '<div style="text-align:center;color:#64748b;font-size:0.85rem;padding:10px;">Keine Daten</div>';
      }
    }
  } catch(e) { console.error('Snapshot error', e); }
}

function handleKeyDown(e) {
  if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
}

function askQuestion(q) {
  document.getElementById('chatInput').value = q;
  sendMessage();
}

function addMessage(role, content, meta) {
  const container = document.getElementById('chatMessages');
  const welcome = document.getElementById('welcomeMessage');
  if (welcome) welcome.remove();
  
  const div = document.createElement('div');
  div.className = 'message message-' + role;
  
  let html = content.replace(/\n/g, '<br>');
  if (meta) {
    html += '<div class="message-meta">' + meta + '</div>';
  }
  div.innerHTML = html;
  
  container.appendChild(div);
  container.scrollTop = container.scrollHeight;
}

function showTyping() {
  const container = document.getElementById('chatMessages');
  const div = document.createElement('div');
  div.className = 'message message-assistant message-typing';
  div.id = 'typingIndicator';
  div.innerHTML = '<span></span><span></span><span></span>';
  container.appendChild(div);
  container.scrollTop = container.scrollHeight;
}

function hideTyping() {
  const el = document.getElementById('typingIndicator');
  if (el) el.remove();
}

async function sendMessage() {
  const input = document.getElementById('chatInput');
  const btn = document.getElementById('sendBtn');
  const message = input.value.trim();
  if (!message || isLoading) return;
  
  const days = document.getElementById('copilot-days').value || 365;
  
  input.value = '';
  input.disabled = true;
  btn.disabled = true;
  isLoading = true;
  
  addMessage('user', message);
  chatHistory.push({role: 'user', content: message});
  showTyping();
  
  try {
    const res = await fetch('/api/copilot/finance/query', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({ question: message, days: parseInt(days) })
    });
    const data = await res.json();
    hideTyping();
    
    if (data && data.answer) {
      let meta = '';
      if (data.snapshot && data.snapshot.kpis) {
        const k = data.snapshot.kpis;
        meta = 'Zeitraum: ' + (data.days || days) + ' Tage ¬∑ ' +
               fmtNumber(k.total_invoices) + ' Rechnungen ¬∑ ' +
               fmtCurrency(k.total_gross) + ' Brutto';
      }
      addMessage('assistant', data.answer, meta);
      chatHistory.push({role: 'assistant', content: data.answer});
      
      // Show suggested questions
      if (data.suggested_questions && data.suggested_questions.length > 0) {
        const suggestions = data.suggested_questions.slice(0,3);
        const suggestHtml = '<div style="margin-top:12px;"><strong>M√∂gliche Folgefragen:</strong><br>' +
          suggestions.map(q => '‚Ä¢ ' + q).join('<br>') + '</div>';
        // Could add as follow-up message or inline
      }
    } else {
      addMessage('assistant', 'Es liegt aktuell keine Antwort vor. Bitte versuchen Sie es erneut.');
    }
  } catch(e) {
    hideTyping();
    addMessage('assistant', 'Verbindungsfehler. Bitte versuchen Sie es erneut.');
    console.error('Copilot error', e);
  }
  
  input.disabled = false;
  btn.disabled = false;
  isLoading = false;
  input.focus();
}

// Input handling
document.getElementById('chatInput').addEventListener('input', function() {
  document.getElementById('sendBtn').disabled = !this.value.trim() || isLoading;
});

// Days change
document.getElementById('copilot-days').addEventListener('change', loadSnapshot);

// Init
loadSnapshot();
</script>

<!-- SBS Chat Widget -->
<link rel="stylesheet" href="https://chat.sbsdeutschland.com/static/chat-widget.css">
<script src="https://chat.sbsdeutschland.com/static/chat-widget.js" defer></script>
<script src="/static/js/app-shell.js"></script>
</body>
</html>
