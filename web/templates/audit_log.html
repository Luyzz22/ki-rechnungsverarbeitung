<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <title>Audit-Log ¬∑ SBS KI-Rechnungsverarbeitung</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="icon" href="/static/favicon.ico" />
  <link rel="stylesheet" href="/static/css/design-tokens.css" />
  <link rel="stylesheet" href="/static/css/components.css" />
  <link rel="stylesheet" href="/static/css/main.css" />
  <style>
    .audit-hero {
      background: linear-gradient(135deg, #003856 0%, #00507a 100%);
      color: white;
      padding: 40px 24px;
      text-align: center;
    }
    .audit-hero h1 { margin: 0; font-size: 2rem; }
    .audit-hero p { margin: 8px 0 0; opacity: 0.9; }
    
    .audit-container { max-width: 1200px; margin: 0 auto; padding: 24px 16px; }
    
    .audit-card {
      background: var(--sbs-card-bg, #fff);
      border: 1px solid var(--sbs-border, #e5e7eb);
      border-radius: 12px;
      padding: 24px;
      margin-bottom: 24px;
    }
    
    .audit-filters {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      margin-bottom: 20px;
    }
    .audit-filters select, .audit-filters input {
      padding: 8px 12px;
      border: 1px solid var(--sbs-border, #e5e7eb);
      border-radius: 6px;
      font-size: 0.9rem;
    }
    
    .audit-table {
      width: 100%;
      border-collapse: collapse;
    }
    .audit-table th, .audit-table td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid var(--sbs-border, #e5e7eb);
    }
    .audit-table th {
      background: var(--sbs-bg-soft, #f9fafb);
      font-weight: 600;
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--sbs-muted, #6b7280);
    }
    .audit-table tr:hover { background: var(--sbs-bg-soft, #f9fafb); }
    
    .action-badge {
      display: inline-flex;
      align-items: center;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 0.75rem;
      font-weight: 600;
    }
    .action-login { background: #dcfce7; color: #15803d; }
    .action-login_failed { background: #fee2e2; color: #991b1b; }
    .action-upload { background: #dbeafe; color: #1d4ed8; }
    .action-export { background: #f3e8ff; color: #7c3aed; }
    .action-delete { background: #fee2e2; color: #991b1b; }
    .action-update { background: #fef3c7; color: #92400e; }
    .action-create { background: #dcfce7; color: #15803d; }
    .action-default { background: #f3f4f6; color: #6b7280; }
    
    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }
    .kpi-card {
      background: var(--sbs-bg-soft, #f9fafb);
      border-radius: 8px;
      padding: 16px;
      text-align: center;
    }
    .kpi-value { font-size: 1.5rem; font-weight: 700; color: var(--sbs-primary, #003856); }
    .kpi-label { font-size: 0.8rem; color: var(--sbs-muted, #6b7280); margin-top: 4px; }
    
    .empty-state {
      text-align: center;
      padding: 40px;
      color: var(--sbs-muted, #6b7280);
    }
    
    .pagination {
      display: flex;
      justify-content: center;
      gap: 8px;
      margin-top: 20px;
    }
    .pagination button {
      padding: 8px 16px;
      border: 1px solid var(--sbs-border, #e5e7eb);
      background: white;
      border-radius: 6px;
      cursor: pointer;
    }
    .pagination button:hover { background: var(--sbs-bg-soft, #f9fafb); }
    .pagination button:disabled { opacity: 0.5; cursor: not-allowed; }
  </style>
</head>
<body>
  {% include 'partials/header.html' %}

  <section class="audit-hero">
    <h1>üìú Audit-Log</h1>
    <p id="accessInfo" style="margin: 8px 0 0; opacity: 0.9; font-size: 0.85rem;"></p>
    <p>Protokoll aller Systemaktivit√§ten - GoBD-konform</p>
  </section>

  <div class="audit-container">
    <!-- KPIs -->
    <div class="kpi-grid">
      <div class="kpi-card">
        <div class="kpi-value" id="totalEntries">-</div>
        <div class="kpi-label">Eintr√§ge gesamt</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-value" id="todayEntries">-</div>
        <div class="kpi-label">Heute</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-value" id="loginCount">-</div>
        <div class="kpi-label">Logins (7 Tage)</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-value" id="failedLogins">-</div>
        <div class="kpi-label">Fehlgeschlagen</div>
      </div>
    </div>

    <!-- Filter & Tabelle -->
    <div class="audit-card">
      <div class="audit-filters">
        <select id="filterAction" onchange="loadAuditLog()">
          <option value="">Alle Aktionen</option>
          <option value="auth.login">Login</option>
          <option value="auth.login_failed">Login fehlgeschlagen</option>
          <option value="auth.logout">Logout</option>
          <option value="invoice.upload">Upload</option>
          <option value="invoice.process">Verarbeitung</option>
          <option value="export">Export</option>
        </select>
        <select id="filterDays" onchange="loadAuditLog()">
          <option value="7">Letzte 7 Tage</option>
          <option value="30">Letzte 30 Tage</option>
          <option value="90">Letzte 90 Tage</option>
          <option value="">Alle</option>
        </select>
        <input type="text" id="filterUser" placeholder="User filtern..." onkeyup="loadAuditLog()" />
      </div>

      <table class="audit-table">
        <thead>
          <tr>
            <th>Zeitpunkt</th>
            <th>Benutzer</th>
            <th>Aktion</th>
            <th>Details</th>
            <th>IP-Adresse</th>
          </tr>
        </thead>
        <tbody id="auditTableBody">
          <tr><td colspan="5" class="empty-state">Lade Audit-Log...</td></tr>
        </tbody>
      </table>

      <div class="pagination">
        <button id="prevBtn" onclick="changePage(-1)" disabled>‚Üê Zur√ºck</button>
        <span id="pageInfo">Seite 1</span>
        <button id="nextBtn" onclick="changePage(1)">Weiter ‚Üí</button>
      </div>
    </div>

    <!-- Info -->
    <div class="audit-card" style="background: #eff6ff; border-color: #bfdbfe;">
      <h3 style="margin: 0 0 8px; font-size: 1rem;">‚ÑπÔ∏è √úber das Audit-Log</h3>
      <p style="margin: 0; font-size: 0.9rem; color: #1e40af;">
        Das Audit-Log protokolliert alle relevanten Systemaktivit√§ten gem√§√ü den Anforderungen der GoBD 
        (Grunds√§tze zur ordnungsm√§√üigen F√ºhrung und Aufbewahrung von B√ºchern). 
        Eintr√§ge k√∂nnen nicht gel√∂scht oder ver√§ndert werden.
      </p>
    </div>
  </div>

  {% include 'partials/footer.html' %}

  <script>
    let currentPage = 1;
    const pageSize = 50;
    let totalPages = 1;

    async function loadAuditLog() {
      const action = document.getElementById('filterAction').value;
      const days = document.getElementById('filterDays').value;
      const userFilter = document.getElementById('filterUser').value.toLowerCase();

      try {
        const res = await fetch(`/api/audit-log?page=${currentPage}&limit=${pageSize}&action=${action}&days=${days}`);
        const data = await res.json();

        if (data.error) {
          document.getElementById('auditTableBody').innerHTML = 
            `<tr><td colspan="5" class="empty-state">${data.error}</td></tr>`;
          return;
        }

        // Access-Info aktualisieren
        const accessInfo = document.getElementById('accessInfo');
        if (data.is_admin) {
          accessInfo.textContent = 'üëë Admin-Ansicht: Alle Systemaktivit√§ten';
        } else {
          accessInfo.textContent = 'üîí Sie sehen nur Ihre eigenen Aktivit√§ten';
        }

        // KPIs aktualisieren
        document.getElementById('totalEntries').textContent = data.stats?.total || 0;
        document.getElementById('todayEntries').textContent = data.stats?.today || 0;
        document.getElementById('loginCount').textContent = data.stats?.logins_7d || 0;
        document.getElementById('failedLogins').textContent = data.stats?.failed_logins || 0;

        // Tabelle rendern
        let entries = data.entries || [];
        
        // Client-side User-Filter
        if (userFilter) {
          entries = entries.filter(e => 
            (e.user_email || '').toLowerCase().includes(userFilter)
          );
        }

        renderTable(entries);

        // Pagination
        totalPages = Math.ceil((data.stats?.total || 0) / pageSize);
        document.getElementById('pageInfo').textContent = `Seite ${currentPage} von ${totalPages || 1}`;
        document.getElementById('prevBtn').disabled = currentPage <= 1;
        document.getElementById('nextBtn').disabled = currentPage >= totalPages;

      } catch (e) {
        console.error(e);
        document.getElementById('auditTableBody').innerHTML = 
          `<tr><td colspan="5" class="empty-state">Fehler beim Laden</td></tr>`;
      }
    }

    function renderTable(entries) {
      const tbody = document.getElementById('auditTableBody');

      if (!entries.length) {
        tbody.innerHTML = '<tr><td colspan="5" class="empty-state">Keine Eintr√§ge gefunden</td></tr>';
        return;
      }

      tbody.innerHTML = entries.map(e => {
        const actionClass = getActionClass(e.action);
        const actionLabel = formatAction(e.action);
        const timestamp = e.timestamp ? new Date(e.timestamp).toLocaleString('de-DE') : '-';

        return `
          <tr>
            <td style="white-space: nowrap;">${timestamp}</td>
            <td>${e.user_email || '<span style="color: #9ca3af;">Anonym</span>'}</td>
            <td><span class="action-badge ${actionClass}">${actionLabel}</span></td>
            <td>${e.details || '-'}</td>
            <td style="font-family: monospace; font-size: 0.8rem;">${e.ip_address || '-'}</td>
          </tr>
        `;
      }).join('');
    }

    function getActionClass(action) {
      if (!action) return 'action-default';
      if (action.includes('login_failed')) return 'action-login_failed';
      if (action.includes('login')) return 'action-login';
      if (action.includes('upload')) return 'action-upload';
      if (action.includes('export')) return 'action-export';
      if (action.includes('delete')) return 'action-delete';
      if (action.includes('update')) return 'action-update';
      if (action.includes('create')) return 'action-create';
      return 'action-default';
    }

    function formatAction(action) {
      const labels = {
        'auth.login': '‚úÖ Login',
        'auth.login_failed': '‚ùå Login fehlgeschlagen',
        'auth.logout': 'üö™ Logout',
        'auth.register': 'üë§ Registrierung',
        'invoice.upload': 'üì§ Upload',
        'invoice.process': '‚öôÔ∏è Verarbeitung',
        'invoice.delete': 'üóëÔ∏è Gel√∂scht',
        'export.datev': 'üìä DATEV-Export',
        'export.csv': 'üìÑ CSV-Export',
        'export.sepa': 'üí≥ SEPA-Export',
        'user.update': '‚úèÔ∏è User bearbeitet',
        'user.role_change': 'üé≠ Rolle ge√§ndert'
      };
      return labels[action] || action;
    }

    function changePage(delta) {
      currentPage += delta;
      if (currentPage < 1) currentPage = 1;
      loadAuditLog();
    }

    // Init
    document.addEventListener('DOMContentLoaded', loadAuditLog);
  </script>
<!-- SBS Chat Widget -->
<link rel="stylesheet" href="https://chat.sbsdeutschland.com/static/chat-widget.css">
<script src="https://chat.sbsdeutschland.com/static/chat-widget.js" defer></script>
</body>
</html>
