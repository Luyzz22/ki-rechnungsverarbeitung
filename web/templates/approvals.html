{% extends "base_app.html" %}

{% block title %}Freigaben{% endblock %}

{% block styles %}
<style>
  .approvals-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: var(--space-6);
  }
  
  .page-header {
    margin-bottom: var(--space-6);
  }
  
  .page-title {
    font-size: var(--text-2xl);
    font-weight: var(--font-bold);
    color: var(--color-text);
    margin-bottom: var(--space-2);
  }
  
  .page-subtitle {
    color: var(--color-text-secondary);
  }
  
  .stats-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: var(--space-4);
    margin-bottom: var(--space-6);
  }
  
  .stat-card {
    background: var(--color-bg);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-xl);
    padding: var(--space-5);
  }
  
  .stat-value {
    font-size: var(--text-3xl);
    font-weight: var(--font-bold);
    color: var(--color-primary);
  }
  
  .stat-value.warning { color: var(--color-warning); }
  .stat-value.success { color: var(--color-success); }
  
  .stat-label {
    font-size: var(--text-sm);
    color: var(--color-text-secondary);
    margin-top: var(--space-1);
  }
  
  .approvals-table-card {
    background: var(--color-bg);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-xl);
    overflow: hidden;
  }
  
  .table-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--space-4) var(--space-5);
    border-bottom: 1px solid var(--color-border);
  }
  
  .filter-tabs {
    display: flex;
    gap: var(--space-2);
  }
  
  .filter-tab {
    padding: var(--space-2) var(--space-4);
    background: transparent;
    border: 1px solid var(--color-border);
    border-radius: var(--radius-full);
    font-size: var(--text-sm);
    color: var(--color-text-secondary);
    cursor: pointer;
    transition: all var(--transition-fast);
  }
  
  .filter-tab:hover {
    background: var(--color-bg-secondary);
  }
  
  .filter-tab.active {
    background: var(--color-primary);
    border-color: var(--color-primary);
    color: var(--color-text-inverse);
  }
  
  .approvals-table {
    width: 100%;
    border-collapse: collapse;
  }
  
  .approvals-table th {
    text-align: left;
    padding: var(--space-3) var(--space-4);
    font-size: var(--text-xs);
    font-weight: var(--font-semibold);
    color: var(--color-text-secondary);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    background: var(--color-bg-secondary);
    border-bottom: 1px solid var(--color-border);
  }
  
  .approvals-table td {
    padding: var(--space-4);
    border-bottom: 1px solid var(--color-border-light);
    font-size: var(--text-sm);
  }
  
  .approvals-table tr:hover {
    background: var(--color-bg-secondary);
  }
  
  .invoice-number {
    font-weight: var(--font-semibold);
    color: var(--color-primary);
  }
  
  .amount {
    font-weight: var(--font-semibold);
    font-family: var(--font-family-mono);
  }
  
  .amount.high { color: var(--color-error); }
  .amount.medium { color: var(--color-warning); }
  
  .status-badge {
    display: inline-flex;
    align-items: center;
    gap: var(--space-1);
    padding: var(--space-1) var(--space-3);
    border-radius: var(--radius-full);
    font-size: var(--text-xs);
    font-weight: var(--font-semibold);
  }
  
  .status-badge.pending {
    background: var(--color-warning-light);
    color: var(--color-warning-dark);
  }
  
  .status-badge.approved {
    background: var(--color-success-light);
    color: var(--color-success-dark);
  }
  
  .status-badge.rejected {
    background: var(--color-error-light);
    color: var(--color-error-dark);
  }
  
  .action-btns {
    display: flex;
    gap: var(--space-2);
  }
  
  .action-btn {
    padding: var(--space-2) var(--space-3);
    border-radius: var(--radius-md);
    font-size: var(--text-xs);
    font-weight: var(--font-medium);
    cursor: pointer;
    transition: all var(--transition-fast);
    border: none;
  }
  
  .action-btn.approve {
    background: var(--color-success);
    color: white;
  }
  
  .action-btn.approve:hover {
    background: var(--color-success-dark);
  }
  
  .action-btn.reject {
    background: var(--color-bg-tertiary);
    color: var(--color-text-secondary);
  }
  
  .action-btn.reject:hover {
    background: var(--color-error-light);
    color: var(--color-error);
  }
  
  .empty-state {
    text-align: center;
    padding: var(--space-16);
    color: var(--color-text-secondary);
  }
  
  .empty-state-icon {
    font-size: 48px;
    margin-bottom: var(--space-4);
  }
</style>
{% endblock %}

{% block content %}
<div class="approvals-container">
  <div class="page-header">
    <h1 class="page-title">Freigaben</h1>
    <p class="page-subtitle">Rechnungen prüfen und freigeben</p>
  </div>
  
  <div class="stats-row">
    <div class="stat-card">
      <div class="stat-value">{{ stats.pending or 0 }}</div>
      <div class="stat-label">Ausstehend</div>
    </div>
    <div class="stat-card">
      <div class="stat-value success">{{ stats.approved_30d or 0 }}</div>
      <div class="stat-label">Freigegeben (30 Tage)</div>
    </div>
    <div class="stat-card">
      <div class="stat-value warning">{{ stats.overdue or 0 }}</div>
      <div class="stat-label">Überfällig</div>
    </div>
    <div class="stat-card">
      <div class="stat-value">{{ stats.avg_days or '–' }}</div>
      <div class="stat-label">Ø Freigabe-Zeit (Tage)</div>
    </div>
  </div>
  
  <div class="approvals-table-card">
    <div class="table-header">
      <div class="filter-tabs">
        <button class="filter-tab active" data-filter="all">Alle</button>
        <button class="filter-tab" data-filter="pending">Ausstehend</button>
        <button class="filter-tab" data-filter="approved">Freigegeben</button>
        <button class="filter-tab" data-filter="rejected">Abgelehnt</button>
      </div>
    </div>
    
    {% if invoices %}
    <table class="approvals-table">
      <thead>
        <tr>
          <th>Rechnung</th>
          <th>Lieferant</th>
          <th>Datum</th>
          <th>Betrag</th>
          <th>Status</th>
          <th>Aktionen</th>
        </tr>
      </thead>
      <tbody>
        {% for inv in invoices %}
        <tr data-status="{{ inv.status or 'pending' }}">
          <td><span class="invoice-number">{{ inv.rechnungsnummer or 'N/A' }}</span></td>
          <td>{{ (inv.rechnungsaussteller or 'Unbekannt')[:25] }}</td>
          <td>{{ inv.datum or '–' }}</td>
          <td>
            <span class="amount {% if inv.betrag_brutto > 5000 %}high{% elif inv.betrag_brutto > 1000 %}medium{% endif %}">
              {{ "%.2f"|format(inv.betrag_brutto or 0) }} €
            </span>
          </td>
          <td>
            <span class="status-badge {{ inv.status or 'pending' }}">
              {% if inv.status == 'approved' %}✓ Freigegeben
              {% elif inv.status == 'rejected' %}✗ Abgelehnt
              {% else %}⏳ Ausstehend{% endif %}
            </span>
          </td>
          <td>
            <div class="action-btns">
              {% if inv.status != 'approved' %}
              <button class="action-btn approve" onclick="approveInvoice({{ inv.id }})">Freigeben</button>
              {% endif %}
              {% if inv.status != 'rejected' %}
              <button class="action-btn reject" onclick="rejectInvoice({{ inv.id }})">Ablehnen</button>
              {% endif %}
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    {% else %}
    <div class="empty-state">
      <div class="empty-state-icon">✅</div>
      <p>Keine ausstehenden Freigaben</p>
    </div>
    {% endif %}
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  // Filter functionality
  document.querySelectorAll('.filter-tab').forEach(tab => {
    tab.addEventListener('click', function() {
      document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
      this.classList.add('active');
      
      const filter = this.dataset.filter;
      document.querySelectorAll('.approvals-table tbody tr').forEach(row => {
        if (filter === 'all' || row.dataset.status === filter) {
          row.style.display = '';
        } else {
          row.style.display = 'none';
        }
      });
    });
  });
  
  async function approveInvoice(id) {
    if (!confirm('Rechnung freigeben?')) return;
    const res = await fetch(`/api/approvals/${id}/approve`, { method: 'POST' });
    if (res.ok) location.reload();
  }
  
  async function rejectInvoice(id) {
    const comment = prompt('Grund für Ablehnung:');
    if (!comment) return;
    const res = await fetch(`/api/approvals/${id}/reject`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ comment })
    });
    if (res.ok) location.reload();
  }
</script>
{% endblock %}
