{% extends "base_app.html" %}

{% block title %}Integrationen{% endblock %}

{% block styles %}
<style>
  .integrations-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: var(--space-6);
  }
  
  .page-header {
    margin-bottom: var(--space-6);
  }
  
  .page-title {
    font-size: var(--text-2xl);
    font-weight: var(--font-bold);
    color: var(--color-text);
    margin-bottom: var(--space-2);
  }
  
  .page-subtitle {
    color: var(--color-text-secondary);
  }
  
  .integrations-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
    gap: var(--space-6);
  }
  
  .integration-card {
    background: var(--color-bg);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-xl);
    overflow: hidden;
  }
  
  .integration-header {
    display: flex;
    align-items: center;
    gap: var(--space-4);
    padding: var(--space-5);
    background: var(--color-bg-secondary);
    border-bottom: 1px solid var(--color-border);
  }
  
  .integration-logo {
    width: 48px;
    height: 48px;
    border-radius: var(--radius-lg);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    color: white;
  }
  
  .integration-logo.lexoffice {
    background: linear-gradient(135deg, #00A3E0, #0077B5);
  }
  
  .integration-logo.sevdesk {
    background: linear-gradient(135deg, #FF6B35, #F7931E);
  }
  
  .integration-logo.datev {
    background: linear-gradient(135deg, #006341, #004d31);
  }
  
  .integration-info {
    flex: 1;
  }
  
  .integration-name {
    font-weight: var(--font-semibold);
    margin-bottom: 2px;
  }
  
  .integration-provider {
    font-size: var(--text-sm);
    color: var(--color-text-secondary);
  }
  
  .status-badge {
    padding: var(--space-1) var(--space-3);
    border-radius: var(--radius-full);
    font-size: var(--text-xs);
    font-weight: var(--font-semibold);
  }
  
  .status-badge.connected {
    background: var(--color-success-light);
    color: var(--color-success-dark);
  }
  
  .status-badge.disconnected {
    background: var(--color-gray-100);
    color: var(--color-gray-600);
  }
  
  .integration-body {
    padding: var(--space-5);
  }
  
  .integration-desc {
    font-size: var(--text-sm);
    color: var(--color-text-secondary);
    margin-bottom: var(--space-4);
  }
  
  .form-group {
    margin-bottom: var(--space-4);
  }
  
  .form-label {
    display: block;
    font-size: var(--text-sm);
    font-weight: var(--font-semibold);
    margin-bottom: var(--space-2);
  }
  
  .form-input {
    width: 100%;
    padding: var(--space-3);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-lg);
    font-size: var(--text-sm);
    font-family: var(--font-family-mono);
  }
  
  .form-hint {
    font-size: var(--text-xs);
    color: var(--color-text-muted);
    margin-top: var(--space-1);
  }
  
  .form-hint a {
    color: var(--color-primary);
  }
  
  .integration-actions {
    display: flex;
    gap: var(--space-2);
  }
  
  .btn-test {
    padding: var(--space-2) var(--space-4);
    background: var(--color-bg-tertiary);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-lg);
    font-size: var(--text-sm);
    cursor: pointer;
    transition: all var(--transition-fast);
  }
  
  .btn-test:hover {
    background: var(--color-bg-secondary);
  }
  
  .btn-save {
    padding: var(--space-2) var(--space-4);
    background: var(--color-primary);
    color: white;
    border: none;
    border-radius: var(--radius-lg);
    font-size: var(--text-sm);
    font-weight: var(--font-medium);
    cursor: pointer;
    transition: all var(--transition-fast);
  }
  
  .btn-save:hover {
    background: var(--color-primary-light);
  }
</style>
{% endblock %}

{% block content %}
<div class="integrations-container">
  <div class="page-header">
    <h1 class="page-title">Integrationen</h1>
    <p class="page-subtitle">Verbinden Sie SBS Invoice mit Ihrer Buchhaltungssoftware</p>
  </div>
  
  <div class="integrations-grid">
    <!-- Lexoffice -->
    <div class="integration-card">
      <div class="integration-header">
        <div class="integration-logo lexoffice">üìä</div>
        <div class="integration-info">
          <div class="integration-name">Lexoffice</div>
          <div class="integration-provider">Lexware / Haufe Group</div>
        </div>
        <span class="status-badge {% if integrations.get('lexoffice', {}).get('enabled') %}connected{% else %}disconnected{% endif %}">
          {% if integrations.get('lexoffice', {}).get('enabled') %}‚úì Verbunden{% else %}Nicht verbunden{% endif %}
        </span>
      </div>
      <div class="integration-body">
        <p class="integration-desc">Synchronisieren Sie Eingangsrechnungen automatisch mit Lexoffice. Kontakte und Belege werden angelegt.</p>
        
        <div class="form-group">
          <label class="form-label">API-Key</label>
          <input type="password" class="form-input" id="lexoffice-key" placeholder="Lexoffice API Key" value="{{ integrations.get('lexoffice', {}).get('api_key', '') }}">
          <div class="form-hint"><a href="https://app.lexoffice.de/settings/public-api" target="_blank">API-Key hier generieren ‚Üí</a></div>
        </div>
        
        <div class="integration-actions">
          <button class="btn-test" onclick="testConnection('lexoffice')">üîå Testen</button>
          <button class="btn-save" onclick="saveIntegration('lexoffice')">üíæ Speichern</button>
        </div>
      </div>
    </div>
    
    <!-- sevDesk -->
    <div class="integration-card">
      <div class="integration-header">
        <div class="integration-logo sevdesk">üßÆ</div>
        <div class="integration-info">
          <div class="integration-name">sevDesk</div>
          <div class="integration-provider">Cloud-Buchhaltung</div>
        </div>
        <span class="status-badge {% if integrations.get('sevdesk', {}).get('enabled') %}connected{% else %}disconnected{% endif %}">
          {% if integrations.get('sevdesk', {}).get('enabled') %}‚úì Verbunden{% else %}Nicht verbunden{% endif %}
        </span>
      </div>
      <div class="integration-body">
        <p class="integration-desc">√úbertragen Sie Belege direkt in sevDesk. Lieferanten werden automatisch angelegt und verkn√ºpft.</p>
        
        <div class="form-group">
          <label class="form-label">API-Token</label>
          <input type="password" class="form-input" id="sevdesk-key" placeholder="sevDesk API Token" value="{{ integrations.get('sevdesk', {}).get('api_key', '') }}">
          <div class="form-hint"><a href="https://my.sevdesk.de/#/admin/userManagement" target="_blank">Token hier generieren ‚Üí</a></div>
        </div>
        
        <div class="integration-actions">
          <button class="btn-test" onclick="testConnection('sevdesk')">üîå Testen</button>
          <button class="btn-save" onclick="saveIntegration('sevdesk')">üíæ Speichern</button>
        </div>
      </div>
    </div>
    
    <!-- DATEV -->
    <div class="integration-card">
      <div class="integration-header">
        <div class="integration-logo datev">üè¢</div>
        <div class="integration-info">
          <div class="integration-name">DATEV</div>
          <div class="integration-provider">Export f√ºr Steuerberater</div>
        </div>
        <span class="status-badge connected">‚úì Verf√ºgbar</span>
      </div>
      <div class="integration-body">
        <p class="integration-desc">Exportieren Sie Buchungsdaten im DATEV-Format (EXTF/CSV, XML) f√ºr Rechnungswesen und Unternehmen Online.</p>
        
        <a href="/datev" class="btn-save" style="display: inline-block; text-decoration: none;">
          üì• Zum DATEV Export ‚Üí
        </a>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  async function testConnection(provider) {
    const key = document.getElementById(provider + '-key').value;
    if (!key) { alert('Bitte API-Key eingeben'); return; }
    
    const res = await fetch('/api/integrations/test', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ provider, api_key: key })
    });
    
    const data = await res.json();
    alert(data.success ? '‚úÖ Verbindung erfolgreich!' : '‚ùå Fehler: ' + data.error);
  }
  
  async function saveIntegration(provider) {
    const key = document.getElementById(provider + '-key').value;
    if (!key) { alert('Bitte API-Key eingeben'); return; }
    
    const res = await fetch('/api/integrations/save', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ provider, api_key: key, enabled: true })
    });
    
    const data = await res.json();
    if (data.success) {
      alert('‚úÖ Gespeichert');
      location.reload();
    } else {
      alert('‚ùå Fehler: ' + data.error);
    }
  }
</script>
{% endblock %}
