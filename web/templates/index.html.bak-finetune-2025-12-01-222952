<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Upload - SBS KI-Rechnungsverarbeitung</title>

  <link rel="stylesheet" href="/static/css/design-tokens.css">
  <link rel="stylesheet" href="/static/css/components.css">
  <link rel="stylesheet" href="/static/css/main.css">

  <style>
    /* Hero & Footer wie vorher */

    .hero-compact {
      background: linear-gradient(135deg, #003856 0%, #004d73 100%);
      color: white;
      padding: 60px 24px;
      text-align: center;
    }

    .hero-badge {
      display: inline-block;
      background: rgba(255,185,0,0.15);
      color: #FFB900;
      padding: 8px 20px;
      border-radius: 24px;
      font-weight: 600;
      margin-bottom: 20px;
    }

    .hero-compact h1 {
      font-size: 2.5rem;
      margin-bottom: 16px;
      color: white;
    }

    .hero-compact p {
      font-size: 1.1rem;
      opacity: 0.9;
      max-width: 700px;
      margin: 0 auto;
    }

    .footer {
      background: #003856;
      color: white;
      padding: 40px 24px 20px;
    }

    .footer-grid {
      max-width: 1200px;
      margin: 0 auto 30px;
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 30px;
    }

    .footer-bottom {
      max-width: 1200px;
      margin: 0 auto;
      padding-top: 20px;
      border-top: 1px solid rgba(255,255,255,0.1);
      text-align: center;
      font-size: 0.9rem;
      opacity: 0.7;
    }

    /* Button Loading States */

    .btn-loading {
      position: relative;
      pointer-events: none;
      opacity: 0.7;
    }

    .btn-loading::after {
      content: '';
      position: absolute;
      width: 16px;
      height: 16px;
      top: 50%;
      left: 50%;
      margin-left: -8px;
      margin-top: -8px;
      border: 2px solid #ffffff;
      border-radius: 50%;
      border-top-color: transparent;
      animation: btn-spin 0.6s linear infinite;
    }

    @keyframes btn-spin {
      to { transform: rotate(360deg); }
    }

    /* === CFO-Level AI Upload Panel === */

    .ai-upload-shell {
      max-width: 960px;
      margin: 60px auto 40px auto;
      padding: 1.75rem 2rem;
      border-radius: 24px;
      background:
        radial-gradient(circle at top left, rgba(80, 200, 255, 0.24), transparent 55%),
        radial-gradient(circle at bottom right, rgba(255, 140, 60, 0.18), transparent 55%),
        rgba(5, 7, 12, 0.95);
      border: 1px solid rgba(255, 255, 255, 0.08);
      box-shadow:
        0 32px 80px rgba(0, 0, 0, 0.75),
        0 0 0 1px rgba(255, 255, 255, 0.02);
      backdrop-filter: blur(18px);
      color: #f9fafb;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif;
    }

    .ai-upload-header {
      margin-bottom: 1.5rem;
    }

    .ai-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.15rem 0.65rem;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.85);
      border: 1px solid rgba(148, 163, 184, 0.6);
      font-size: 0.72rem;
      text-transform: uppercase;
      letter-spacing: 0.16em;
      color: #e5e7eb;
    }

    .ai-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: radial-gradient(circle, #22d3ee, #0ea5e9);
      box-shadow: 0 0 12px rgba(56, 189, 248, 0.85);
    }

    .ai-upload-title {
      font-size: 1.5rem;
      line-height: 1.25;
      margin: 0.75rem 0 0.35rem;
      font-weight: 600;
    }

    .ai-upload-subtitle {
      margin: 0;
      font-size: 0.9rem;
      color: #9ca3af;
      max-width: 620px;
    }

    .ai-upload-dropzone {
      position: relative;
      margin-top: 1.25rem;
      padding: 1.75rem 1.5rem 1.5rem;
      border-radius: 20px;
      background: radial-gradient(circle at top, rgba(15, 23, 42, 0.95), rgba(15, 23, 42, 0.98));
      border: 1px dashed rgba(148, 163, 184, 0.45);
      overflow: hidden;
      cursor: pointer;
      transition:
        border-color 140ms ease-out,
        box-shadow 140ms ease-out,
        transform 140ms ease-out,
        background 160ms ease-out;
    }

    .ai-upload-dropzone:hover {
      border-color: rgba(56, 189, 248, 0.7);
      box-shadow: 0 20px 50px rgba(15, 23, 42, 0.9);
      transform: translateY(-1px);
    }

    .ai-upload-dropzone.is-dragover {
      border-style: solid;
      border-color: rgba(56, 189, 248, 0.95);
      box-shadow:
        0 0 0 1px rgba(56, 189, 248, 0.6),
        0 24px 80px rgba(8, 47, 73, 0.9);
      background: radial-gradient(circle at top, rgba(8, 47, 73, 0.95), rgba(15, 23, 42, 0.98));
    }

    .ai-upload-orbit-bg {
      position: absolute;
      inset: -40%;
      background:
        radial-gradient(circle at 20% -10%, rgba(56, 189, 248, 0.2), transparent 60%),
        radial-gradient(circle at 80% 120%, rgba(249, 115, 22, 0.16), transparent 60%);
      opacity: 0.9;
      pointer-events: none;
    }

    .ai-upload-inner {
      position: relative;
      display: flex;
      align-items: center;
      gap: 1.5rem;
      z-index: 1;
    }

    .ai-upload-icon-orbit {
      position: relative;
      width: 96px;
      height: 96px;
      flex-shrink: 0;
      display: grid;
      place-items: center;
    }

    .ai-upload-core {
      position: relative;
      width: 52px;
      height: 52px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 0%, #f97316, #111827 75%);
      box-shadow:
        0 0 0 1px rgba(248, 250, 252, 0.12),
        0 0 30px rgba(248, 113, 22, 0.75);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .ai-upload-core-text {
      font-size: 0.9rem;
      font-weight: 600;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      color: #fefce8;
    }

    .ai-upload-ring {
      position: absolute;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.4);
    }

    .ai-upload-ring-outer {
      width: 86px;
      height: 38px;
      transform: rotate(-15deg);
      border-color: rgba(56, 189, 248, 0.7);
      box-shadow: 0 0 16px rgba(56, 189, 248, 0.8);
    }

    .ai-upload-ring-inner {
      width: 70px;
      height: 28px;
      transform: rotate(18deg);
      border-color: rgba(251, 146, 60, 0.85);
      box-shadow: 0 0 14px rgba(251, 146, 60, 0.8);
    }

    .ai-upload-copy {
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
    }

    .ai-upload-mainline {
      font-size: 1.05rem;
      font-weight: 500;
    }

    .ai-upload-secondary {
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.18em;
      color: #6b7280;
    }

    .ai-upload-button {
      margin-top: 0.4rem;
      align-self: flex-start;
      border: none;
      border-radius: 999px;
      padding: 0.55rem 1.1rem;
      background: linear-gradient(135deg, #22c55e, #14b8a6);
      color: #f9fafb;
      font-size: 0.85rem;
      font-weight: 500;
      cursor: pointer;
      box-shadow:
        0 12px 30px rgba(5, 150, 105, 0.45),
        0 0 0 1px rgba(15, 23, 42, 0.7);
      transition:
        transform 120ms ease-out,
        box-shadow 120ms ease-out,
        filter 120ms ease-out;
    }

    .ai-upload-button:hover {
      transform: translateY(-1px);
      filter: brightness(1.06);
      box-shadow:
        0 16px 40px rgba(5, 150, 105, 0.6),
        0 0 0 1px rgba(15, 23, 42, 0.8);
    }

    .ai-upload-button:active {
      transform: translateY(0);
      box-shadow:
        0 8px 18px rgba(5, 150, 105, 0.45),
        0 0 0 1px rgba(15, 23, 42, 0.9);
    }

    .ai-upload-meta {
      margin-top: 0.25rem;
      font-size: 0.72rem;
      color: #9ca3af;
    }

    .ai-upload-footer {
      position: relative;
      margin-top: 1.25rem;
      z-index: 1;
    }

    .ai-upload-pills {
      display: flex;
      flex-wrap: wrap;
      gap: 0.4rem;
    }

    .ai-pill {
      padding: 0.16rem 0.65rem;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.5);
      background: rgba(15, 23, 42, 0.85);
      font-size: 0.7rem;
      color: #e5e7eb;
      white-space: nowrap;
    }

    .ai-upload-status {
      margin-top: 16px;
      font-size: 0.8rem;
      color: #9ca3af;
    }

    @media (max-width: 720px) {
      .ai-upload-shell {
        padding: 1.4rem 1.25rem;
        margin: 32px 16px 24px 16px;
      }

      .ai-upload-inner {
        flex-direction: column;
        align-items: flex-start;
      }

      .ai-upload-icon-orbit {
        margin-bottom: 0.5rem;
      }

      .ai-upload-title {
        font-size: 1.25rem;
      }
    }

    /* === CFO-Level Datei-Liste & Fortschritt === */

    .demo-section {
      max-width: 960px;
      margin: 0 auto 60px auto;
      padding: 0 16px;
    }

    .demo-card {
      background: white;
      border-radius: 18px;
      padding: 24px 24px 20px 24px;
      box-shadow: 0 10px 30px rgba(15, 23, 42, 0.08);
      margin-bottom: 24px;
    }

    .demo-card-title {
      margin: 0 0 16px 0;
      font-size: 1.1rem;
      color: #003856;
    }

    .demo-file-list {
      max-height: 420px;
      overflow-y: auto;
      margin-bottom: 20px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .demo-file-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 16px;
      border-radius: 12px;
      border: 1px solid #e5e7eb;
      background: #f9fafb;
    }

    .demo-file-main {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .demo-file-icon {
      font-size: 1.8rem;
    }

    .demo-file-name {
      font-weight: 600;
      color: #003856;
    }

    .demo-file-size {
      font-size: 0.85rem;
      color: #6b7280;
    }

    .demo-file-remove {
      background: #ef4444;
      color: white;
      border: none;
      padding: 8px 14px;
      border-radius: 999px;
      cursor: pointer;
      font-size: 0.85rem;
      font-weight: 600;
    }

    .demo-progress-icon {
      font-size: 3rem;
      margin-bottom: 16px;
      text-align: center;
    }

    .demo-progress-bar {
      width: 100%;
      height: 36px;
      background: #e5e7eb;
      border-radius: 18px;
      overflow: hidden;
      margin: 24px 0 12px 0;
      position: relative;
    }

    .demo-progress-fill {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, #003856 0%, #ffb900 100%);
      transition: width 0.3s;
    }

    .demo-progress-text {
      text-align: center;
      color: #4b5563;
      margin: 0;
    }

    /* Toast */

    #toastContainer {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 9999;
    }

    .toast {
      min-width: 300px;
      max-width: 400px;
      padding: 16px 20px;
      margin-bottom: 12px;
      border-radius: 12px;
      box-shadow: 0 8px 24px rgba(0,0,0,0.15);
      display: flex;
      align-items: center;
      gap: 12px;
      animation: slideIn 0.3s ease-out;
      background: white;
      border-left: 4px solid;
    }

    .toast.success { border-color: #22c55e; }
    .toast.error { border-color: #ef4444; }
    .toast.info { border-color: #3b82f6; }
    .toast.warning { border-color: #f59e0b; }

    .toast-icon {
      font-size: 1.5rem;
      flex-shrink: 0;
    }

    .toast-content {
      flex: 1;
    }

    .toast-title {
      font-weight: 600;
      color: #1f2937;
      margin-bottom: 4px;
    }

    .toast-message {
      font-size: 0.9rem;
      color: #6b7280;
    }

    .toast-close {
      background: none;
      border: none;
      font-size: 1.2rem;
      color: #9ca3af;
      cursor: pointer;
      padding: 0;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 4px;
    }

    .toast-close:hover {
      background: #f3f4f6;
      color: #4b5563;
    }

    @keyframes slideIn {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    @keyframes slideOut {
      from {
        transform: translateX(0);
        opacity: 1;
      }
      to {
        transform: translateX(400px);
        opacity: 0;
      }
    }
  </style>
</head>
<body>

<header class="header">
  <div class="header-inner">
    <a href="/" class="logo-wrap">
      <img src="/static/sbs-logo-new.png" alt="SBS Deutschland" class="logo-img" />
      <div class="logo-text">
        <strong>SBS Deutschland</strong>
        <span>Smart Business Service ¬∑ Weinheim</span>
      </div>
    </a>

    <button class="burger" id="burger" aria-label="Men√º">
      <span></span><span></span><span></span>
    </button>

    <nav class="nav" id="nav">
      <a href="/">Upload</a>
      <a href="/history">Verlauf</a>
      <a href="/analytics">Analytics</a>
      <a href="/email-config">Email-Inbox</a>

      <div class="account-dropdown">
        <span class="account-toggle">
          üë§ <span id="accountName">Account</span> ‚ñæ
        </span>
        <div class="account-menu">
          <div class="section-label">Workspace</div>
          <a href="/">üì• Upload</a>
          <a href="/history">üìä Verlauf</a>
          <a href="/analytics">üìà Analytics</a>
          <a href="/email-config">üìß Email-Inbox</a>

          <div class="divider"></div>
          <div class="section-label">Konto</div>
          <a href="/account">üí≥ Konto &amp; Nutzung</a>
          <a href="/team">üë• Team &amp; Rollen</a>
          <a href="/audit-log">üìú Audit-Log</a>
          <a href="/profile">‚öôÔ∏è Einstellungen</a>

          <div class="divider"></div>
          <div class="section-label">SBS Website</div>
          <a href="https://sbsdeutschland.com/preise" target="_blank" rel="noreferrer">üí∂ Preise</a>
          <a href="https://sbsdeutschland.com/sbshomepage/kontakt.html" target="_blank" rel="noreferrer">‚úâÔ∏è Kontakt</a>

          <div class="divider"></div>
          <a href="/logout">üö™ Logout</a>
        </div>
      </div>
    </nav>
  </div>
</header>

<main class="main-content">
  <div class="hero-compact">
    <div class="hero-content">
      <div class="hero-badge">ü§ñ KI-RECHNUNGSVERARBEITUNG</div>
      <h1>Rechnungen intelligent verarbeiten</h1>
      <p>Laden Sie Ihre Rechnungen hoch und unsere KI extrahiert automatisch alle relevanten Daten.</p>
    </div>
  </div>

  <section style="max-width:1200px;margin:60px auto;padding:0 24px;">
    <!-- CFO-Level Upload Panel, beh√§lt ID uploadBox f√ºr Onboarding & JS -->
    <section id="uploadBox" class="ai-upload-shell">
      <header class="ai-upload-header">
        <div class="ai-badge">
          <span class="ai-dot"></span>
          <span class="ai-badge-text">Quantum AI Finance</span>
        </div>
        <h2 class="ai-upload-title">Belege fallen lassen. Erkenntnisse einsammeln.</h2>
        <p class="ai-upload-subtitle">
          Ziehen Sie PDF-, PNG- oder JPG-Rechnungen hierher ‚Äì unsere KI extrahiert Betr√§ge,
          Lieferanten und Zahlungsziele in Sekunden und √ºbergibt die Daten an Ihr ERP.
        </p>
      </header>

      <div id="upload-dropzone" class="ai-upload-dropzone" aria-label="Rechnungen hochladen">
        <div class="ai-upload-orbit-bg"></div>

        <div class="ai-upload-inner">
          <div class="ai-upload-icon-orbit">
            <div class="ai-upload-core">
              <span class="ai-upload-core-text">AI</span>
            </div>
            <div class="ai-upload-ring ai-upload-ring-outer"></div>
            <div class="ai-upload-ring ai-upload-ring-inner"></div>
          </div>

          <div class="ai-upload-copy">
            <div class="ai-upload-mainline">Dateien hier ablegen</div>
            <div class="ai-upload-secondary">oder</div>
            <button type="button" id="upload-browse-btn" class="ai-upload-button">
              Dateien ausw√§hlen
            </button>
            <input
              id="upload-file-input"
              type="file"
              accept=".pdf,.png,.jpg,.jpeg"
              multiple
              hidden
            />
            <div class="ai-upload-meta">
              <span>Enterprise-grade Security ¬∑</span>
              <span> SOC2-ready ¬∑</span>
              <span> Inference in EU-Rechenzentren</span>
            </div>
          </div>
        </div>

        <footer class="ai-upload-footer">
          <div class="ai-upload-pills">
            <span class="ai-pill">Auto-Posting in ERP</span>
            <span class="ai-pill">Anomalie-Erkennung</span>
            <span class="ai-pill">Skalierbar wie NVIDIA</span>
          </div>
        </footer>
      </div>

      <div id="upload-status" class="ai-upload-status"></div>
    </section>

    <!-- CFO-Level Datei-Liste & Fortschritt -->
    <section class="demo-section">
      <div id="fileListBox" class="demo-card" style="display:none;">
        <h3 class="demo-card-title">
          üìã Hochgeladene Dateien (<span id="fileCount">0</span>)
        </h3>
        <div id="fileList" class="demo-file-list"></div>
        <button id="processBtn" class="btn btn-accent btn-lg btn-block">
          ‚ö° Jetzt verarbeiten
        </button>
      </div>

      <div id="progressBox" class="demo-card" style="display:none;">
        <div class="demo-progress-icon">‚öôÔ∏è</div>
        <h2 class="demo-card-title">Verarbeitung l√§uft ‚Ä¶</h2>
        <div class="demo-progress-bar">
          <div id="progressFill" class="demo-progress-fill"></div>
        </div>
        <p id="progressText" class="demo-progress-text">Bitte warten ‚Ä¶</p>
      </div>
    </section>
  </section>
</main>

<footer class="footer">
  <div class="footer-grid">
    <div>
      <div class="footer-brand">
        <img src="/static/sbs-logo-new.png" alt="SBS Deutschland" />
        <div class="footer-brand-text">
          <strong>SBS Deutschland</strong>
          <span>Smart Business Service</span>
        </div>
      </div>
      <p class="footer-tagline">
        Ihr Partner f√ºr intelligente Gesch√§ftsprozesse und KI-L√∂sungen aus der Rhein-Neckar-Region.
      </p>
      <div class="footer-location">üìç In der Dell 19, 69469 Weinheim</div>
    </div>

    <div>
      <h4>Produkte</h4>
      <ul>
        <li><a href="/landing">KI-Rechnungsverarbeitung</a></li>
        <li><a href="/preise">Preise &amp; Pakete</a></li>
        <li><a href="https://app.sbsdeutschland.com/">Demo &amp; Upload</a></li>
      </ul>
    </div>

    <div>
      <h4>Unternehmen</h4>
      <ul>
        <li><a href="/sbshomepage/unternehmen.html">√úber uns</a></li>
        <li><a href="/sbshomepage/kontakt.html">Kontakt</a></li>
        <li><a href="/sbshomepage/it-consulting.html">IT Consulting</a></li>
        <li><a href="/sbshomepage/sap-consulting.html">SAP Consulting</a></li>
      </ul>
    </div>

    <div>
      <h4>Rechtliches</h4>
      <ul>
        <li><a href="/sbshomepage/impressum.html">Impressum</a></li>
        <li><a href="/sbshomepage/datenschutz.html">Datenschutz</a></li>
        <li><a href="/sbshomepage/agb.html">AGB</a></li>
      </ul>
    </div>
  </div>

  <div class="footer-bottom">
    <p>&copy; 2025 SBS Deutschland GmbH &amp; Co. KG. Alle Rechte vorbehalten.</p>
    <p>Made with ‚ù§Ô∏è in Weinheim</p>
  </div>
</footer>

<div id="toastContainer"></div>

<script src="/static/js/main.js"></script>

<script>
  // --- Toasts ---
  function showToast(message, type = 'info', duration = 4000) {
    const container = document.getElementById('toastContainer');
    if (!container) return;

    const toast = document.createElement('div');
    toast.className = 'toast ' + type;

    const icons = {
      success: '‚úÖ',
      error: '‚ùå',
      info: '‚ÑπÔ∏è',
      warning: '‚ö†Ô∏è'
    };

    const titles = {
      success: 'Erfolg',
      error: 'Fehler',
      info: 'Information',
      warning: 'Warnung'
    };

    toast.innerHTML =
      '<div class="toast-icon">' + (icons[type] || '‚ÑπÔ∏è') + '</div>' +
      '<div class="toast-content">' +
      '<div class="toast-title">' + (titles[type] || 'Info') + '</div>' +
      '<div class="toast-message">' + message + '</div>' +
      '</div>' +
      '<button class="toast-close" onclick="this.parentElement.remove()">√ó</button>';

    container.appendChild(toast);

    setTimeout(() => {
      toast.style.animation = 'slideOut 0.3s ease-in';
      setTimeout(() => toast.remove(), 300);
    }, duration);
  }

  // Einfacher Fehler-Wrapper
  function showError(errorTypeOrMessage, customMessage) {
    const msg = customMessage || errorTypeOrMessage || 'Ein Fehler ist aufgetreten.';
    showToast(msg, 'error', 5000);
  }

  // --- Upload-State & File-Liste ---

  let files = [];

  const uploadShell = document.getElementById('uploadBox');
  const fileListBox = document.getElementById('fileListBox');
  const fileList = document.getElementById('fileList');

  function addFiles(newFiles) {
    const list = Array.prototype.slice.call(newFiles || []);
    if (!list.length) return;

    for (const f of list) {
      if (f.size > 20 * 1024 * 1024) {
        showError('file_too_large', f.name + ' ist zu gro√ü (max. 20 MB).');
        continue;
      }
      files.push(f);
    }
    renderFileList();
  }

  function renderFileList() {
    if (!files.length) {
      fileListBox.style.display = 'none';
      return;
    }
    fileListBox.style.display = 'block';
    document.getElementById('fileCount').textContent = String(files.length);
    fileList.innerHTML = '';

    files.forEach((f, index) => {
      const icon = f.type === 'application/pdf' ? 'üìï' : 'üñºÔ∏è';
      const row = document.createElement('div');
      row.className = 'demo-file-row';

      row.innerHTML =
        '<div class="demo-file-main">' +
          '<div class="demo-file-icon">' + icon + '</div>' +
          '<div>' +
            '<div class="demo-file-name">' + f.name + '</div>' +
            '<div class="demo-file-size">' + (f.size / 1024 / 1024).toFixed(2) + ' MB</div>' +
          '</div>' +
        '</div>' +
        '<button type="button" class="demo-file-remove" data-index="' + index + '">‚úï</button>';

      row.querySelector('.demo-file-remove').addEventListener('click', function () {
        removeFile(index);
      });

      fileList.appendChild(row);
    });
  }

  function removeFile(index) {
    files.splice(index, 1);
    renderFileList();
  }

  // --- Upload & Verarbeitung ---

  function startProcessing() {
    const processBtn = document.getElementById('processBtn');
    const progressBox = document.getElementById('progressBox');
    const progressFill = document.getElementById('progressFill');
    const progressText = document.getElementById('progressText');

    if (!files.length || !processBtn) return;

    processBtn.disabled = true;
    processBtn.classList.add('btn-loading');

    fileListBox.style.display = 'none';
    if (progressBox) progressBox.style.display = 'block';
    if (progressFill) progressFill.style.width = '0%';
    if (progressText) progressText.textContent = 'Upload startet ‚Ä¶';

    (async () => {
      try {
        const fd = new FormData();
        files.forEach(f => fd.append('files', f));

        const r = await fetch('/api/upload', {
          method: 'POST',
          body: fd
        });
        const data = await r.json();

        if (data.error) {
          showError(data.error, data.error);
          if (data.redirect) window.location.href = data.redirect;
          return;
        }

        const jobId = data.batch_id || data.job_id;
        if (!jobId) {
          throw new Error('Kein Job-Identifier vom Server erhalten.');
        }

        connectWebSocket(jobId);
        showToast('Upload erfolgreich! Verarbeitung gestartet ‚Ä¶', 'success', 3000);

        await fetch('/api/process/' + jobId, { method: 'POST' });
        pollProgress(jobId);
      } catch (e) {
        console.error(e);
        showError('Fehler beim Upload: ' + e.message);
        if (progressBox) progressBox.style.display = 'none';
        if (files.length) {
          fileListBox.style.display = 'block';
        }
      }
    })();
  }

  function pollProgress(jobId) {
    const progressFill = document.getElementById('progressFill');
    const progressText = document.getElementById('progressText');

    const timer = setInterval(async () => {
      try {
        const r = await fetch('/api/status/' + jobId);
        const d = await r.json();

        const processed = d.processed || 0;
        const total = d.total || 1;
        const pct = Math.round((processed / total) * 100);

        if (progressFill) progressFill.style.width = pct + '%';
        if (progressText) {
          progressText.textContent =
            processed + ' von ' + (d.total || 0) + ' Dateien verarbeitet ‚Äì ' + pct + '%';
        }

        if (d.status === 'completed') {
          clearInterval(timer);
          window.location.href = '/job/' + jobId;
        } else if (d.status === 'error') {
          clearInterval(timer);
          showError('Verarbeitung konnte nicht abgeschlossen werden.');
        }
      } catch (e) {
        console.error(e);
        // kurzes Netzproblem -> ignorieren, Polling l√§uft weiter
      }
    }, 2000);
  }

  // --- CFO Dropzone-Logik ---

  (function () {
    const dropzone = document.getElementById('upload-dropzone');
    const browseBtn = document.getElementById('upload-browse-btn');
    const fileInput = document.getElementById('upload-file-input');

    if (!dropzone || !browseBtn || !fileInput) {
      console.warn('AI-Upload-Elemente nicht gefunden.');
      return;
    }

    function preventDefaults(e) {
      e.preventDefault();
      e.stopPropagation();
    }

    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(function (eventName) {
      dropzone.addEventListener(eventName, preventDefaults, false);
    });

    ['dragenter', 'dragover'].forEach(function (eventName) {
      dropzone.addEventListener(eventName, function () {
        dropzone.classList.add('is-dragover');
      });
    });

    dropzone.addEventListener('dragleave', function (e) {
      if (!dropzone.contains(e.relatedTarget)) {
        dropzone.classList.remove('is-dragover');
      }
    });

    dropzone.addEventListener('drop', function (e) {
      dropzone.classList.remove('is-dragover');
      const droppedFiles = Array.prototype.slice.call(
        (e.dataTransfer && e.dataTransfer.files) || []
      );
      if (!droppedFiles.length) return;
      addFiles(droppedFiles);
    });

    browseBtn.addEventListener('click', function () {
      fileInput.click();
    });

    fileInput.addEventListener('change', function (e) {
      const selectedFiles = Array.prototype.slice.call(e.target.files || []);
      if (!selectedFiles.length) return;
      addFiles(selectedFiles);
      fileInput.value = '';
    });
  })();

  // --- WebSocket f√ºr Live-Updates ---

  let ws = null;
  let currentJobId = null;

  function connectWebSocket(jobId) {
    currentJobId = jobId;
    const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
    const url = protocol + '//' + window.location.host + '/ws/' + jobId;

    try {
      ws = new WebSocket(url);
    } catch (e) {
      console.warn('WebSocket konnte nicht ge√∂ffnet werden:', e);
      return;
    }

    ws.onopen = function () {
      console.log('‚úÖ WebSocket connected');
    };

    ws.onmessage = function (event) {
      let message;
      try {
        message = JSON.parse(event.data);
      } catch (e) {
        return;
      }
      if (!message || !message.type) return;

      switch (message.type) {
        case 'progress':
          updateProgressFromServer(message);
          break;
        case 'job_complete':
          if (ws) ws.close();
          if (currentJobId) {
            window.location.href = '/job/' + currentJobId;
          }
          break;
        case 'error':
          showError(message.error || 'Fehler bei der Verarbeitung.');
          break;
      }
    };

    ws.onerror = function (error) {
      console.error('‚ùå WebSocket error:', error);
    };

    ws.onclose = function () {
      console.log('WebSocket closed');
    };
  }

  function updateProgressFromServer(message) {
    const progressFill = document.getElementById('progressFill');
    const progressText = document.getElementById('progressText');
    const statusDiv = document.getElementById('upload-status');

    const processed = message.current || message.processed || 0;
    const total = message.total || 1;
    const pct = message.percentage != null
      ? message.percentage
      : Math.round(processed / total * 100);

    if (progressFill) progressFill.style.width = pct + '%';
    if (progressText) {
      progressText.textContent =
        processed + ' von ' + total + ' Dateien verarbeitet ‚Äì ' + pct + '%';
    }

    if (statusDiv) {
      statusDiv.textContent =
        'Live-Update: ' + processed + ' / ' + total + ' Rechnungen verarbeitet (' + pct + '%).';
    }
  }

  // --- Account-Name & Button-Init ---

  document.addEventListener('DOMContentLoaded', function () {
    const processBtn = document.getElementById('processBtn');
    if (processBtn) {
      processBtn.addEventListener('click', startProcessing);
    }

    fetch('/api/user')
      .then((r) => r.json())
      .then((u) => {
        const toggle = document.querySelector('.account-toggle');
        const menu = document.querySelector('.account-menu');
        if (u.logged_in && u.name) {
          document.getElementById('accountName').textContent = u.name;
        } else if (toggle) {
          toggle.innerHTML =
            '<a href="/login?next=/" style="text-decoration:none;color:inherit;">üîë Login</a>';
          if (menu) menu.style.display = 'none';
        }
      })
      .catch(() => {});
  });
</script>

</body>
</html>
