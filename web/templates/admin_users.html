<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>User Management - SBS Deutschland</title>
  <link rel="stylesheet" href="/static/css/design-tokens.css">
  <link rel="stylesheet" href="/static/css/components.css">
  <link rel="stylesheet" href="/static/css/main.css">
  <style>
    .users-table { width: 100%; border-collapse: collapse; background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    .users-table th, .users-table td { padding: 14px 16px; text-align: left; border-bottom: 1px solid #e5e7eb; }
    .users-table th { background: #f8f9fa; font-weight: 600; color: #374151; }
    .users-table tr:hover { background: #f8f9fa; }
    
    .status-badge { padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 500; }
    .status-badge.active { background: #d1fae5; color: #065f46; }
    .status-badge.inactive { background: #fee2e2; color: #991b1b; }
    
    .btn-sm { padding: 6px 12px; font-size: 13px; border-radius: 6px; cursor: pointer; border: none; }
    .btn-danger { background: #ef4444; color: white; }
    .btn-danger:hover { background: #dc2626; }
    .btn-edit { background: #3b82f6; color: white; }
    .btn-edit:hover { background: #2563eb; }
    
    .stats-row { display: flex; gap: 20px; margin-bottom: 30px; }
    .stat-box { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); flex: 1; }
    .stat-box h4 { color: #666; font-size: 13px; margin: 0 0 8px 0; }
    .stat-box .value { font-size: 28px; font-weight: bold; color: #003856; }
    
    .search-bar { display: flex; gap: 15px; margin-bottom: 20px; }
    .search-bar input { flex: 1; padding: 12px 16px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; }
    .search-bar select { padding: 12px 16px; border: 1px solid #ddd; border-radius: 8px; }
    
    .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
    .modal.show { display: flex; }
    .modal-content { background: white; border-radius: 12px; padding: 30px; max-width: 500px; width: 90%; }
    .modal-content h3 { margin: 0 0 20px 0; color: #003856; }
    .form-group { margin-bottom: 15px; }
    .form-group label { display: block; margin-bottom: 6px; font-weight: 500; color: #374151; }
    .form-group input, .form-group select { width: 100%; padding: 10px 12px; border: 1px solid #ddd; border-radius: 6px; }
  </style>
</head>
<body>
  {% include 'partials/header.html' %}
  
  <section class="section-padding" style="background: #f5f5f5; min-height: calc(100vh - 200px);">
    <div class="container">
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
        <h1 style="color: #003856; margin: 0;">üë• User Management</h1>
        <button class="btn btn-primary" onclick="showAddModal()">+ Neuer Benutzer</button>
      </div>
      
      <!-- Stats -->
      <div class="stats-row">
        <div class="stat-box">
          <h4>Gesamt</h4>
          <div class="value">{{ users|length }}</div>
        </div>
        <div class="stat-box">
          <h4>Aktiv</h4>
          <div class="value">{{ users|selectattr('is_active', 'equalto', 1)|list|length }}</div>
        </div>
        <div class="stat-box">
          <h4>Diese Woche neu</h4>
          <div class="value">{{ new_this_week }}</div>
        </div>
      </div>
      
      <!-- Search -->
      <div class="search-bar">
        <input type="text" id="searchInput" placeholder="Suchen nach Name oder Email..." onkeyup="filterUsers()">
        <select id="statusFilter" onchange="filterUsers()">
          <option value="">Alle Status</option>
          <option value="active">Aktiv</option>
          <option value="inactive">Inaktiv</option>
        </select>
      </div>
      
      <!-- Users Table -->
      <table class="users-table" id="usersTable">
        <thead>
          <tr>
            <th>ID</th>
            <th>Name</th>
            <th>Email</th>
            <th>Rechnungen</th>
            <th>Registriert</th>
            <th>Status</th>
            <th>Aktionen</th>
          </tr>
        </thead>
        <tbody>
          {% for user in users %}
          <tr data-name="{{ user.name or '' }}" data-email="{{ user.email }}" data-status="{{ 'active' if user.is_active else 'inactive' }}">
            <td>{{ user.id }}</td>
            <td>{{ user.name or '-' }}</td>
            <td>{{ user.email }}</td>
            <td>{{ user.invoice_count or 0 }}</td>
            <td>{{ user.created_at[:10] if user.created_at else '-' }}</td>
            <td>
              <span class="status-badge {{ 'active' if user.is_active else 'inactive' }}">
                {{ 'Aktiv' if user.is_active else 'Inaktiv' }}
              </span>
            </td>
            <td>
              <button class="btn-sm btn-edit" onclick="editUser({{ user.id }}, '{{ user.name }}', '{{ user.email }}', {{ user.is_active }})">‚úèÔ∏è</button>
              {% if user.is_active %}
              <button class="btn-sm btn-danger" onclick="toggleUser({{ user.id }}, 0)">üö´</button>
              {% else %}
              <button class="btn-sm btn-edit" onclick="toggleUser({{ user.id }}, 1)">‚úÖ</button>
              {% endif %}
            </td>
          </tr>
          {% else %}
          <tr><td colspan="7" style="text-align: center; color: #666;">Keine Benutzer</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </section>
  
  <!-- Add/Edit Modal -->
  <div class="modal" id="userModal">
    <div class="modal-content">
      <h3 id="modalTitle">Neuer Benutzer</h3>
      <form id="userForm" onsubmit="saveUser(event)">
        <input type="hidden" id="userId" value="">
        <div class="form-group">
          <label>Name</label>
          <input type="text" id="userName" required>
        </div>
        <div class="form-group">
          <label>Email</label>
          <input type="email" id="userEmail" required>
        </div>
        <div class="form-group" id="passwordGroup">
          <label>Passwort</label>
          <input type="password" id="userPassword" minlength="8">
        </div>
        <div style="display: flex; gap: 10px; margin-top: 20px;">
          <button type="submit" class="btn btn-primary">Speichern</button>
          <button type="button" class="btn btn-secondary" onclick="closeModal()">Abbrechen</button>
        </div>
      </form>
    </div>
  </div>
  
  <script>
    function filterUsers() {
      const search = document.getElementById('searchInput').value.toLowerCase();
      const status = document.getElementById('statusFilter').value;
      const rows = document.querySelectorAll('#usersTable tbody tr');
      
      rows.forEach(row => {
        const name = row.dataset.name?.toLowerCase() || '';
        const email = row.dataset.email?.toLowerCase() || '';
        const rowStatus = row.dataset.status;
        
        const matchSearch = name.includes(search) || email.includes(search);
        const matchStatus = !status || rowStatus === status;
        
        row.style.display = matchSearch && matchStatus ? '' : 'none';
      });
    }
    
    function showAddModal() {
      document.getElementById('modalTitle').textContent = 'Neuer Benutzer';
      document.getElementById('userId').value = '';
      document.getElementById('userName').value = '';
      document.getElementById('userEmail').value = '';
      document.getElementById('userPassword').value = '';
      document.getElementById('passwordGroup').style.display = 'block';
      document.getElementById('userModal').classList.add('show');
    }
    
    function editUser(id, name, email, isActive) {
      document.getElementById('modalTitle').textContent = 'Benutzer bearbeiten';
      document.getElementById('userId').value = id;
      document.getElementById('userName').value = name || '';
      document.getElementById('userEmail').value = email;
      document.getElementById('passwordGroup').style.display = 'none';
      document.getElementById('userModal').classList.add('show');
    }
    
    function closeModal() {
      document.getElementById('userModal').classList.remove('show');
    }
    
    async function saveUser(e) {
      e.preventDefault();
      const id = document.getElementById('userId').value;
      const data = {
        name: document.getElementById('userName').value,
        email: document.getElementById('userEmail').value,
        password: document.getElementById('userPassword').value
      };
      
      const url = id ? `/api/admin/users/${id}` : '/api/admin/users';
      const method = id ? 'PUT' : 'POST';
      
      const resp = await fetch(url, {
        method,
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(data)
      });
      
      if (resp.ok) {
        location.reload();
      } else {
        alert('Fehler beim Speichern');
      }
    }
    
    async function toggleUser(id, active) {
      if (!confirm(active ? 'Benutzer aktivieren?' : 'Benutzer deaktivieren?')) return;
      
      const resp = await fetch(`/api/admin/users/${id}/toggle`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({is_active: active})
      });
      
      if (resp.ok) {
        location.reload();
      }
    }
  </script>
  
  {% include 'partials/footer.html' %}
</body>
</html>
